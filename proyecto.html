<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proyecto</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> 
</head>
<body class="detail-page-body">
    <a href="index.html" class="back-link">&larr; Volver a todos los proyectos</a>
    <main id="project-detail-content" class="project-detail-container"></main>
    <footer>
        <p>© 2025 iLupo Warehouse | Administrado por alberto64674yt</p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js"></script>

    <script>
        marked.setOptions({ gfm: true, breaks: true });
        Prism.plugins.autoloader.languages_path = 'https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/';
        let lightbox; // Variable global para la instancia de la galería

        function initializeGallery() {
            if (lightbox) {
                lightbox.destroy(); // Destruye la galería anterior si existe (útil para la previsualización)
            }
            // Inicializa la nueva galería para todas las imágenes de la descripción
            lightbox = GLightbox({
                selector: '.project-description a[href$=".jpg"], .project-description a[href$=".jpeg"], .project-description a[href$=".png"], .project-description a[href$=".gif"], .project-description a[href$=".webp"]',
                loop: true,
                touchNavigation: true
            });
        }

        function renderProjectDetails(proyecto) {
            const container = document.getElementById('project-detail-content');
            if (!proyecto || !proyecto.titulo) { container.innerHTML = '<h1>Proyecto no encontrado</h1>'; return; }
            document.title = proyecto.titulo + " | iLupo Warehouse";
            
            let rawContent = proyecto.contenido_completo || '';
            const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([\w-]{11})/g;
            rawContent = rawContent.replace(youtubeRegex, (m, id) => `<div class="video-container"><iframe src="https://www.youtube.com/embed/${id}" frameborder="0" allowfullscreen></iframe></div>`);
            const downloadImgRegex = /\[IMAGEN-DESCARGA\]\(([^,]+),\s*([^)]+)\)/g;
            rawContent = rawContent.replace(downloadImgRegex, (m, img, dl) => `<a href="${dl}" class="download-image-link" target="_blank"><img src="${img}" alt="Imagen de descarga"/></a>`);
            let finalHtml = marked.parse(rawContent);

            // Envuelve las imágenes del contenido Markdown en enlaces para que la galería funcione
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = finalHtml;
            tempDiv.querySelectorAll('img').forEach(img => {
                if (img.parentElement.tagName !== 'A') {
                    const link = document.createElement('a');
                    link.href = img.src;
                    link.classList.add('glightbox');
                    img.parentNode.insertBefore(link, img);
                    link.appendChild(img);
                }
            });
            finalHtml = tempDiv.innerHTML;

            let tagsHtml = '';
            if (proyecto.tags && proyecto.tags.length > 0) {
                tagsHtml = '<div class="project-tags">Etiquetas: ';
                tagsHtml += proyecto.tags.map(tag => `<a href="tags.html?tag=${encodeURIComponent(tag.trim())}" class="tag-link">${tag.trim()}</a>`).join('');
                tagsHtml += '</div>';
            }

            container.innerHTML = `
                <h1 class="project-title">${proyecto.titulo}</h1>
                <img class="project-hero-image" src="${proyecto.imagen}" alt="${proyecto.titulo}">
                <div class="project-description">${finalHtml}</div>
                ${tagsHtml}
                ${proyecto.enlace ? `<a href="${proyecto.enlace}" class="button project-button" target="_blank">Enlace Principal</a>` : ''}
            `;
            
            Prism.highlightAll(); // Resalta la sintaxis del código
            initializeGallery(); // Pone en marcha la galería
        }
        
        window.addEventListener('message', e => { 
            if (e.data.type === 'detailPreviewUpdate') {
                renderProjectDetails(e.data.payload);
            }
        });

        function loadPublishedProject() {
            const params = new URLSearchParams(window.location.search);
            const proyectoId = params.get('id');
            if (!proyectoId) return; 
            fetch('proyectos.json')
                .then(r => r.json())
                .then(data => renderProjectDetails((data.items || []).find(p => p.id === proyectoId)));
        }
        document.addEventListener('DOMContentLoaded', loadPublishedProject);
    </script>
</body>
</html>
