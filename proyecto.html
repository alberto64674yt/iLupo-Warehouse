<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proyecto</title>
	<meta name="description" content="">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css">
    <link rel="icon" type="image/png" href="/favicon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon/favicon.svg" />
    <link rel="shortcut icon" href="/favicon/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
    <link rel="manifest" href="/favicon/site.webmanifest" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> 
</head>
<body class="detail-page-body">
    <a href="index.html" class="back-link">&larr; Volver a todos los proyectos</a>
    <main id="project-detail-content" class="project-detail-container"></main>
    <footer>
        <p>© 2025 iLupo Warehouse | Administrado por alberto64674yt</p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/toolbar/prism-toolbar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js"></script>

    <script>
        marked.setOptions({ gfm: true, breaks: true });
        Prism.plugins.autoloader.languages_path = 'https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/';
        let lightbox;
		
		let currentProjectData = null; // Guardará los datos del proyecto actual

        // Pequeña función para mostrar notificaciones en esta página
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.position = 'fixed';
            notification.style.bottom = '20px';
            notification.style.left = '50%';
            notification.style.transform = 'translateX(-50%)';
            notification.style.backgroundColor = 'var(--primary-color)';
            notification.style.color = 'var(--dark-bg)';
            notification.style.padding = '10px 20px';
            notification.style.borderRadius = '8px';
            notification.style.zIndex = '1001';
            notification.style.fontWeight = 'bold';
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
		
		function switchLanguage(lang) {
            if (!currentProjectData) return;

            // Comprobar si la traducción existe
            if (!currentProjectData.titulo[lang] || currentProjectData.titulo[lang].trim() === '') {
                showNotification('Translation not available');
                return;
            }

            // Actualizar los textos
            document.querySelector('[data-lang-text="titulo"]').innerHTML = currentProjectData.titulo[lang];
            document.querySelector('.project-hero-image').alt = currentProjectData.titulo[lang];

            // Re-procesar y renderizar el contenido de Markdown en el nuevo idioma
            let rawContent = currentProjectData.contenido_completo[lang] || '';
            const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([\w-]{11})/g;
            rawContent = rawContent.replace(youtubeRegex, (m, id) => `<div class="video-container"><iframe src="https://www.youtube.com/embed/${id}" frameborder="0" allowfullscreen></iframe></div>`);
            const downloadImgRegex = /\[IMAGEN-DESCARGA\]\(([^,]+),\s*([^)]+)\)/g;
            rawContent = rawContent.replace(downloadImgRegex, (m, img, dl) => `<a href="${dl}" class="download-image-link" target="_blank"><img src="${img}" alt="Imagen de descarga"/></a>`);
            rawContent = parseCustomShortcodes(rawContent);
            let finalHtml = marked.parse(rawContent);

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = finalHtml;
            tempDiv.querySelectorAll('img').forEach(img => {
                if (img.parentElement.tagName !== 'A') {
                    const link = document.createElement('a');
                    link.href = img.src;
                    link.classList.add('glightbox');
                    img.parentNode.insertBefore(link, img);
                    link.appendChild(img);
                }
            });
            tempDiv.querySelectorAll('table').forEach(table => {
                const wrapper = document.createElement('div');
                wrapper.className = 'table-wrapper';
                table.parentNode.insertBefore(wrapper, table);
                wrapper.appendChild(table);
            });
            finalHtml = tempDiv.innerHTML;

            document.querySelector('[data-lang-text="contenido_completo"]').innerHTML = finalHtml;

            // Actualizar el estado visual de los botones
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.lang-btn[data-lang="${lang}"]`).classList.add('active');

            // Re-inicializar plugins que dependen del contenido
            Prism.highlightAll();
            initializeGallery();
            initializeTabs();
        }

        function initializeGallery() {
            if (lightbox) {
                lightbox.destroy();
            }
            lightbox = GLightbox({
                selector: '.project-description a[href$=".jpg"], .project-description a[href$=".jpeg"], .project-description a[href$=".png"], .project-description a[href$=".gif"], .project-description a[href$=".webp"]',
                loop: true,
                touchNavigation: true
            });
        }

        // --- INICIO: NUEVAS FUNCIONES PARA COMPONENTES ---

        // Función para inicializar la interactividad de las pestañas (Tabs)
        function initializeTabs() {
            const tabContainers = document.querySelectorAll('.tabs-container');
            tabContainers.forEach(container => {
                const navButtons = container.querySelectorAll('.tab-button');
                const contentPanels = container.querySelectorAll('.tab-content');

                navButtons.forEach((button, index) => {
                    button.addEventListener('click', () => {
                        // Ocultar todos y quitar 'active'
                        navButtons.forEach(btn => btn.classList.remove('active'));
                        contentPanels.forEach(panel => panel.classList.remove('active'));

                        // Mostrar el seleccionado
                        button.classList.add('active');
                        contentPanels[index].classList.add('active');
                    });
                });
            });
        }

        // "Traductor" de Shortcodes a HTML
        function parseCustomShortcodes(content) {
            let processedContent = content;

            // 1. Spoilers: [spoiler:título]...[/spoiler]
            processedContent = processedContent.replace(/\[spoiler:([^\]]+)\]([\s\S]*?)\[\/spoiler\]/g, (match, title, innerContent) => {
                return `<details><summary>${title}</summary>${marked.parse(innerContent)}</details>`;
            });

            // 2. Alertas: [tipo]...[/tipo]
            processedContent = processedContent.replace(/\[(nota|aviso|info)\]([\s\S]*?)\[\/\1\]/g, (match, type, innerContent) => {
                return `<div class="alert alert-${type}">${marked.parse(innerContent)}</div>`;
            });

            // 3. Pestañas (Tabs)
            processedContent = processedContent.replace(/\[tabs\]([\s\S]*?)\[\/tabs\]/g, (match, innerContent) => {
                const navLinks = [];
                const tabContents = [];
                const tabRegex = /\[tab:([^\]]+)\]([\s\S]*?)(?=\[tab:|$)/g;
                let tabMatch;
                
                while ((tabMatch = tabRegex.exec(innerContent)) !== null) {
                    navLinks.push(tabMatch[1]); // Título de la pestaña
                    tabContents.push(marked.parse(tabMatch[2])); // Contenido de la pestaña
                }

                if (navLinks.length === 0) return '';

                const navHtml = navLinks.map((title, index) => 
                    `<button class="tab-button ${index === 0 ? 'active' : ''}">${title}</button>`
                ).join('');

                const contentHtml = tabContents.map((content, index) =>
                    `<div class="tab-content ${index === 0 ? 'active' : ''}">${content}</div>`
                ).join('');

                return `<div class="tabs-container"><div class="tabs-nav">${navHtml}</div>${contentHtml}</div>`;
            });
            
            return processedContent;
        }

        // --- FIN: NUEVAS FUNCIONES PARA COMPONENTES ---


        function renderProjectDetails(proyecto) {
            currentProjectData = proyecto; // Guardamos los datos del proyecto en la variable global
            const container = document.getElementById('project-detail-content');
            if (!proyecto || !proyecto.titulo) { container.innerHTML = '<h1>Proyecto no encontrado</h1>'; return; }
            document.title = proyecto.titulo.es + " | iLupo Warehouse";
			
			const metaDescription = document.querySelector('meta[name="description"]');
			if (metaDescription && proyecto.resumen && proyecto.resumen.es) {
    		    metaDescription.setAttribute('content', proyecto.resumen.es.replace(/[*_#`~>]/g, ''));
			}
			
            let rawContent = proyecto.contenido_completo.es || ''; // Cargamos español por defecto
            const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([\w-]{11})/g;
            rawContent = rawContent.replace(youtubeRegex, (m, id) => `<div class="video-container"><iframe src="https://www.youtube.com/embed/${id}" frameborder="0" allowfullscreen></iframe></div>`);
            const downloadImgRegex = /\[IMAGEN-DESCARGA\]\(([^,]+),\s*([^)]+)\)/g;
            rawContent = rawContent.replace(downloadImgRegex, (m, img, dl) => `<a href="${dl}" class="download-image-link" target="_blank"><img src="${img}" alt="Imagen de descarga"/></a>`);
            
            rawContent = parseCustomShortcodes(rawContent);

            let finalHtml = marked.parse(rawContent);

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = finalHtml;
            
            tempDiv.querySelectorAll('img').forEach(img => {
                if (img.parentElement.tagName !== 'A') {
                    const link = document.createElement('a');
                    link.href = img.src;
                    link.classList.add('glightbox');
                    img.parentNode.insertBefore(link, img);
                    link.appendChild(img);
                }
            });

            tempDiv.querySelectorAll('table').forEach(table => {
                const wrapper = document.createElement('div');
                wrapper.className = 'table-wrapper';
                table.parentNode.insertBefore(wrapper, table);
                wrapper.appendChild(table);
            });

            finalHtml = tempDiv.innerHTML;
            
            let tagsHtml = '';
            if (proyecto.tags && proyecto.tags.length > 0) {
                tagsHtml = '<div class="project-tags">Etiquetas: ';
                proyecto.tags.forEach(fullTagPath => {
                    const parts = fullTagPath.split(' > ');
                    const breadcrumbs = parts.map(part => {
                        return `<a href="tags.html?tag=${encodeURIComponent(part.trim())}" class="tag-link">${part.trim()}</a>`;
                    }).join(' &gt; ');
                    tagsHtml += `<div style="margin-bottom: 8px;">${breadcrumbs}</div>`;
                });
                tagsHtml += '</div>';
            }
            
            container.innerHTML = `
                <h1 class="project-title" data-lang-text="titulo">${proyecto.titulo.es}</h1>
                <div class="lang-switcher">
                    <button class="lang-btn active" data-lang="es" title="Ver en español">🇪🇸</button>
                    <button class="lang-btn" data-lang="en" title="View in English">🇬🇧</button>
                </div>
                <img class="project-hero-image" src="${proyecto.imagen}" alt="${proyecto.titulo.es}">
                <div class="project-description" data-lang-text="contenido_completo">${finalHtml}</div>
                ${tagsHtml}
                ${proyecto.enlace ? `<a href="${proyecto.enlace}" class="button project-button" target="_blank">Enlace Principal</a>` : ''}
            `;
            
            // Añadir los event listeners a los botones recién creados
            container.querySelector('.lang-btn[data-lang="es"]').addEventListener('click', () => switchLanguage('es'));
            container.querySelector('.lang-btn[data-lang="en"]').addEventListener('click', () => switchLanguage('en'));

            Prism.highlightAll();
            initializeGallery();
            initializeTabs();
        }
        
        window.addEventListener('message', e => { 
            if (e.data.type === 'detailPreviewUpdate') {
                renderProjectDetails(e.data.payload);
            }
        });

        function loadPublishedProject() {
            const params = new URLSearchParams(window.location.search);
            const proyectoId = params.get('id');
            if (!proyectoId) { 
                document.getElementById('project-detail-content').innerHTML = '<h1>Error: No se ha especificado un ID de proyecto.</h1>';
                return;
            }
            fetch('proyectos.json')
                .then(r => r.json())
                .then(data => {
                    const project = (data.items || []).find(p => p.id === proyectoId);
                    renderProjectDetails(project);
                });
        }
		// Avisamos al panel de que la vista previa está lista para recibir datos
			if (window.self !== window.top) { // Solo se ejecuta si está en un iframe
				window.parent.postMessage({ type: 'previewReady' }, '*');
			}
		document.addEventListener('DOMContentLoaded', loadPublishedProject);
    </script>
	
	<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js').then(registration => {
        console.log('ServiceWorker registrado con éxito:', registration.scope);
      }).catch(error => {
        console.log('Fallo en el registro del ServiceWorker:', error);
      });
    });
  }
</script>

</body>
</html>
