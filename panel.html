<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Control - iLupo Warehouse</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body class="panel-body">
    <div class="panel-container">
        <div class="editor-pane">
            <div id="admin-panel">
                <h1>Panel de Control</h1>
                <fieldset>
                    <legend>Parte 1: Datos para la Tarjeta (Resumen)</legend>
                    <div class="form-section">
                        <label for="titulo">Título del Proyecto</label>
                        <input type="text" id="titulo" oninput="updatePreview()">
                        <label for="id">ID para la URL (ej: mi-proyecto-1)</label>
                        <input type="text" id="id" oninput="updatePreview()">
                        <label for="resumen">Resumen Corto (para la tarjeta)</label>
                        <textarea id="resumen" oninput="updatePreview()"></textarea>
                        <label for="imagen">URL de la Imagen Principal</label>
                        <input type="text" id="imagen" oninput="updatePreview()">
                    </div>
                </fieldset>
                <fieldset>
                    <legend>Parte 2: Contenido de la Página de Detalle</legend>
                    <div class="form-section">
                        <label for="contenido_completo">Descripción Completa (soporta Markdown)</label>
                        <textarea id="contenido_completo" oninput="updatePreview()"></textarea>
                        <div class="markdown-ayuda">
                            <p><b>**Negrita**</b> &nbsp;&nbsp; <i>*Cursiva*</i> &nbsp;&nbsp; `---` (Línea)</p>
                            <p><b>Listas:</b> Empieza la línea con `- ` o `1. `</p>
                            <p><b>Títulos:</b> `## Título Mediano`, `### Título Pequeño`</p>
                            <p><b>Cita:</b> `> Texto citado`</p>
                            <p><b>Enlace:</b> `[texto visible](https://url.com)`</p>
                            <p><b>Imagen:</b> `![alt text](https://url/imagen.jpg)`</p>
                            <p><b>YouTube:</b> Pega el link en una línea nueva.</p>
                            <p><b>Img Descarga:</b> `[IMAGEN-DESCARGA](url_img, url_zip)`</p>
                        </div>
                        <label for="enlace">URL del Botón Principal (opcional)</label>
                        <input type="text" id="enlace" oninput="updatePreview()">
                    </div>
                </fieldset>
                <div class="form-actions">
                    <button id="main-button" onclick="submitProject()">Añadir Proyecto a la Lista</button>
                    <button id="cancel-button" onclick="cancelEdit()" style="display: none;">Cancelar Edición</button>
                </div>
                <hr>
                <div class="manage-container">
                    <h2>Gestionar Proyectos Existentes</h2>
                    <div id="manage-list"></div>
                </div>
                <hr>
                <div class="save-container">
                    <h2>Paso Final: Guardar Todo</h2>
                    <button class="save-button" onclick="saveAndDownload()">Generar y Descargar Fichero</button>
                </div>
            </div>
        </div>
        <div class="preview-pane">
            <div class="preview-switcher">
                <button id="btn-list-view" class="active" onclick="switchToListView()">Vista Tarjetas</button>
                <button id="btn-detail-view" onclick="switchToDetailView()">Vista Detalle</button>
            </div>
            <iframe id="preview-frame" src="index.html"></iframe>
        </div>
    </div>
    <script>
        let currentProjects = []; let editingIndex = -1; let previewMode = 'list';
        const previewFrame = document.getElementById('preview-frame');
        const btnListView = document.getElementById('btn-list-view');
        const btnDetailView = document.getElementById('btn-detail-view');

        function loadInitialData(){fetch('proyectos.json').then(r=>r.json()).then(d=>{currentProjects=d.items||[];renderManageList();previewFrame.onload=()=>{updatePreview()}})}
        function renderManageList(){const c=document.getElementById('manage-list');c.innerHTML='';if(currentProjects.length===0){c.innerHTML='<p>No hay proyectos.</p>';return}
        [...currentProjects].reverse().forEach((p,i)=>{const o=currentProjects.length-1-i;const t=document.createElement('div');t.className='manage-item';t.innerHTML=`<span>${p.titulo}</span><div class="manage-buttons"><button class="edit-button" onclick="editProject(${o})">Editar</button><button class="delete-button" onclick="deleteProject(${o})">Borrar</button></div>`;c.appendChild(t)})}
        
        function updatePreview() {
            const tempProject = {titulo:document.getElementById('titulo').value,id:document.getElementById('id').value,resumen:document.getElementById('resumen').value,contenido_completo:document.getElementById('contenido_completo').value,imagen:document.getElementById('imagen').value,enlace:document.getElementById('enlace').value};
            if (previewMode === 'list') {
                let liveProjects = [...currentProjects];
                if (editingIndex > -1) { liveProjects[editingIndex] = tempProject; } 
                else if (tempProject.titulo) { liveProjects.push(tempProject); }
                previewFrame.contentWindow.postMessage({ type: 'previewUpdate', payload: liveProjects }, '*');
            } else { // previewMode === 'detail'
                previewFrame.contentWindow.postMessage({ type: 'detailPreviewUpdate', payload: tempProject }, '*');
            }
        }
        
        function switchToListView() {
            previewMode = 'list';
            btnListView.classList.add('active');
            btnDetailView.classList.remove('active');
            if (previewFrame.src.includes('proyecto.html')) {
                previewFrame.src = 'index.html';
                previewFrame.onload = () => updatePreview();
            } else { updatePreview(); }
        }

        function switchToDetailView() {
            previewMode = 'detail';
            btnListView.classList.remove('active');
            btnDetailView.classList.add('active');
            if (previewFrame.src.includes('index.html')) {
                previewFrame.src = 'proyecto.html';
                previewFrame.onload = () => updatePreview();
            } else { updatePreview(); }
        }

        function editProject(i){editingIndex=i;const p=currentProjects[i];document.getElementById('titulo').value=p.titulo;document.getElementById('id').value=p.id;document.getElementById('resumen').value=p.resumen;document.getElementById('contenido_completo').value=p.contenido_completo;document.getElementById('imagen').value=p.imagen;document.getElementById('enlace').value=p.enlace;
        document.getElementById('main-button').innerText='Guardar Cambios';document.getElementById('cancel-button').style.display='block';window.scrollTo(0,0);switchToDetailView();}
        function cancelEdit(){editingIndex=-1;clearForm();document.getElementById('main-button').innerText='Añadir Proyecto a la Lista';document.getElementById('cancel-button').style.display='none';switchToListView();}
        function deleteProject(i){if(confirm(`¿Borrar "${currentProjects[i].titulo}"?`)){currentProjects.splice(i,1);renderManageList();previewFrame.contentWindow.postMessage({type:'previewUpdate',payload:currentProjects},'*');alert('Proyecto borrado.')}}
        function submitProject(){const p={titulo:document.getElementById('titulo').value,id:document.getElementById('id').value,resumen:document.getElementById('resumen').value,contenido_completo:document.getElementById('contenido_completo').value,imagen:document.getElementById('imagen').value,enlace:document.getElementById('enlace').value};if(!p.titulo||!p.id||!p.resumen||!p.contenido_completo||!p.imagen){alert('Faltan campos obligatorios.');return}
        if(editingIndex>-1){currentProjects[editingIndex]=p;alert('Proyecto actualizado.');cancelEdit()}else{currentProjects.push(p);alert('Proyecto añadido.');clearForm()}
        renderManageList();switchToListView();}
        function saveAndDownload(){const f=JSON.stringify({items:currentProjects},null,2);const b=new Blob([f],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='proyectos.json';a.click();URL.revokeObjectURL(a.href)}
        function clearForm(){document.getElementById('titulo').value='';document.getElementById('id').value='';document.getElementById('resumen').value='';document.getElementById('contenido_completo').value='';document.getElementById('imagen').value='';document.getElementById('enlace').value=''}
        loadInitialData();
    </script>
</body>
</html>
