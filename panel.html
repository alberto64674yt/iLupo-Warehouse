<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Control - iLupo Warehouse</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body class="panel-layout">
    <div class="editor-pane">
        <div id="admin-panel">
            <h1>Panel de Control</h1>
            <div class="form-container">
                <h3>Añadir Nuevo Proyecto</h3>
                <input type="text" id="titulo" placeholder="Título del proyecto" oninput="updatePreview()">
                <input type="text" id="id" placeholder="ID para la URL (ej: mi-proyecto-1)" oninput="updatePreview()">
                <textarea id="resumen" placeholder="Resumen para la tarjeta (texto corto)" oninput="updatePreview()"></textarea>
                <textarea id="contenido_completo" placeholder="Contenido completo de la página (soporta Markdown)" oninput="updatePreview()"></textarea>
                <div class="markdown-ayuda">
                    <p><b>Ayuda:</b> **negrita**, *cursiva*, [enlace](url), `https://link.youtube.com`, `[IMAGEN-DESCARGA](url_imagen, url_descarga)`</p>
                </div>
                <input type="text" id="imagen" placeholder="URL de la imagen principal" oninput="updatePreview()">
                <input type="text" id="enlace" placeholder="URL del botón principal (opcional)" oninput="updatePreview()">
                <button onclick="addProject()">Añadir Proyecto a la Lista</button>
            </div>
            <hr>
            <div class="manage-container">
                <h2>Gestionar Proyectos Existentes</h2>
                <div id="manage-list"></div>
            </div>
            <hr>
            <div class="save-container">
                <h2>Paso Final: Guardar Todo</h2>
                <p>Pulsa para descargar el fichero <strong>proyectos.json</strong> actualizado. Reemplaza el antiguo con este.</p>
                <button class="save-button" onclick="saveAndDownload()">Generar y Descargar Fichero</button>
            </div>
        </div>
    </div>
    <div class="preview-pane">
        <iframe id="preview-frame" src="index.html"></iframe>
    </div>
    <script>
        let currentProjects = [];
        const previewFrame = document.getElementById('preview-frame');

        function loadInitialData() {
            fetch('proyectos.json')
            .then(response => response.json())
            .then(data => {
                currentProjects = data.items || [];
                renderManageList();
                previewFrame.onload = () => previewFrame.contentWindow.postMessage({ type: 'previewUpdate', payload: currentProjects }, '*');
                if (document.readyState === "complete") {
                    previewFrame.contentWindow.postMessage({ type: 'previewUpdate', payload: currentProjects }, '*');
                }
            });
        }

        // --- NUEVA FUNCIÓN PARA MOSTRAR LA LISTA DE GESTIÓN ---
        function renderManageList() {
            const listContainer = document.getElementById('manage-list');
            listContainer.innerHTML = '';
            if (currentProjects.length === 0) {
                listContainer.innerHTML = '<p>No hay proyectos en la lista.</p>';
                return;
            }
            const reversedProjects = [...currentProjects].reverse();
            reversedProjects.forEach((proyecto, index) => {
                const originalIndex = currentProjects.length - 1 - index;
                const projectElement = document.createElement('div');
                projectElement.className = 'manage-item';
                projectElement.innerHTML = `
                    <span>${proyecto.titulo}</span>
                    <button class="delete-button" onclick="deleteProject(${originalIndex})">Borrar</button>
                `;
                listContainer.appendChild(projectElement);
            });
        }
        
        // --- NUEVA FUNCIÓN PARA BORRAR ---
        function deleteProject(index) {
            if (confirm(`¿Seguro que quieres borrar el proyecto "${currentProjects[index].titulo}"?`)) {
                currentProjects.splice(index, 1);
                renderManageList();
                updatePreview(true); // Actualiza la preview con la lista ya modificada
                alert('Proyecto borrado de la lista. Pulsa "Generar y Descargar" para guardar los cambios.');
            }
        }

        function updatePreview(forceUpdate = false) {
            const tempProject = {
                titulo: document.getElementById('titulo').value,
                id: document.getElementById('id').value,
                resumen: document.getElementById('resumen').value,
                contenido_completo: document.getElementById('contenido_completo').value,
                imagen: document.getElementById('imagen').value,
                enlace: document.getElementById('enlace').value
            };
            // Si no estamos borrando, añadimos el proyecto temporal para la preview en vivo
            const liveProjects = forceUpdate ? [...currentProjects] : [...currentProjects, tempProject];
            previewFrame.contentWindow.postMessage({ type: 'previewUpdate', payload: liveProjects }, '*');
        }

        function addProject() {
            const proyecto = {
                titulo: document.getElementById('titulo').value,
                id: document.getElementById('id').value,
                resumen: document.getElementById('resumen').value,
                contenido_completo: document.getElementById('contenido_completo').value,
                imagen: document.getElementById('imagen').value,
                enlace: document.getElementById('enlace').value
            };
            if (!proyecto.titulo || !proyecto.id || !proyecto.resumen || !proyecto.contenido_completo || !proyecto.imagen) {
                alert('Todos los campos son obligatorios (excepto el enlace del botón).'); return;
            }
            currentProjects.push(proyecto);
            renderManageList(); // Actualizar la lista de gestión
            document.getElementById('titulo').value = '';
            document.getElementById('id').value = '';
            document.getElementById('resumen').value = '';
            document.getElementById('contenido_completo').value = '';
            document.getElementById('imagen').value = '';
            document.getElementById('enlace').value = '';
            updatePreview(true); // Actualizar la preview con el proyecto ya añadido
            alert('Proyecto añadido a la lista. Pulsa "Generar y Descargar" para guardar.');
        }

        function saveAndDownload() {
            const fileContent = JSON.stringify({ items: currentProjects }, null, 2);
            const blob = new Blob([fileContent], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'proyectos.json';
            a.click();
            URL.revokeObjectURL(a.href);
        }
        
        loadInitialData();
    </script>
</body>
</html>
