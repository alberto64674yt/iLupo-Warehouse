<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF--8">
    <title>Panel de Control - iLupo Warehouse</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
</head>
<body class="panel-body">
    <div class="panel-container">
        <div class="editor-pane">
            <div id="admin-panel">
                <a href="index.html" class="back-to-site-button">← Volver a la Web Principal</a>
                <h1>Panel de Control</h1>
                
                <fieldset>
                    <legend>Gestionar Proyectos</legend>
                    <div class="form-section">
                        <label for="titulo">Título del Proyecto</label>
                        <input type="text" id="titulo" oninput="updatePreview()">
                        <label for="id">ID para la URL (ej: mi-proyecto-1)</label>
                        <input type="text" id="id" oninput="updatePreview(); validateId();">
                        <small id="id-error" style="color: var(--danger-color); margin-top: -0.75rem; display: block; height: 1rem;"></small>
                        <label for="resumen">Resumen Corto (para la tarjeta)</label>
                        <textarea id="resumen" oninput="updatePreview()"></textarea>
                        <label for="imagen">URL de la Imagen Principal</label>
                        <input type="text" id="imagen" oninput="updatePreview()">
                        <button class="upload-button" onclick="triggerUpload('imagen', 'input')">Subir a ImgBB</button>

                        <label for="tags">Etiquetas (separadas por comas)</label>
                        <input type="text" id="tags" placeholder="Ej: Programación > Python, Juegos > Minecraft > Mods" oninput="updatePreview()">
                        <label for="contenido_completo">Descripción Completa (Markdown)</label>
                        <div class="markdown-toolbar">
                            <button onclick="applyMarkdown('bold', 'contenido_completo')" title="Negrita"><b>B</b></button>
                            <button onclick="applyMarkdown('italic', 'contenido_completo')" title="Cursiva"><i>I</i></button>
                            <button onclick="applyMarkdown('strike', 'contenido_completo')" title="Tachado"><s>S</s></button>
                            <button onclick="applyMarkdown('link', 'contenido_completo')" title="Enlace">Enlace</button>
                            <button onclick="applyMarkdown('image', 'contenido_completo')" title="Insertar URL de Imagen">Imagen</button>
                            <button onclick="applyMarkdown('imgbb-image', 'contenido_completo')" title="Subir Imagen a ImgBB">ImgBB</button>
                            <button onclick="applyMarkdown('download-image', 'contenido_completo')" title="Imagen con Descarga (URL)">[Img-DL]</button>
                            <button onclick="applyMarkdown('imgbb-link-image', 'contenido_completo')" title="Subir Imagen con Enlace (ImgBB)">[ImgBB+Link]</button>
                            <button onclick="applyMarkdown('quote', 'contenido_completo')" title="Cita">Cita</button>
                            <button onclick="applyMarkdown('code_block', 'contenido_completo')" title="Bloque de Código">Bloque</button>
                            <button onclick="applyMarkdown('hr', 'contenido_completo')" title="Línea horizontal">Línea</button>
                            <button onclick="applyMarkdown('h2', 'contenido_completo')" title="Título 2">Tít 2</button>
                            <button onclick="applyMarkdown('h3', 'contenido_completo')" title="Título 3">Tít 3</button>
                            <button onclick="applyMarkdown('ul', 'contenido_completo')" title="Lista">Lista</button>
                            <button onclick="applyMarkdown('ol', 'contenido_completo')" title="Lista Num.">Lista Num.</button>
                        </div>
                        <textarea id="contenido_completo" oninput="updatePreview()"></textarea>
                        <label for="enlace">URL del Botón Principal (opcional)</label>
                        <input type="text" id="enlace" oninput="updatePreview()">
                    </div>
                    <div class="form-actions">
                        <button id="main-button" onclick="submitProject()">Añadir Proyecto</button>
                        <button id="cancel-button" onclick="cancelEdit()" style="display:none;">Cancelar</button>
                    </div>
                </fieldset>

                <div class="manage-container">
                    <h2>Proyectos Existentes (Arrastra para ordenar)</h2>
                    <div id="manage-list"></div>
                </div>
                <hr>
                <div class="save-container">
                    <button class="save-button" onclick="saveProjects()">Generar y Descargar proyectos.json</button>
                </div>
                <hr>
                 <fieldset>
                    <legend>Editar Página "Sobre Mí"</legend>
                    <label for="contenido_sobre_mi">Contenido de la página (Markdown)</label>
                    <div class="markdown-toolbar">
                        <button onclick="applyMarkdown('bold', 'contenido_sobre_mi')" title="Negrita"><b>B</b></button>
                        <button onclick="applyMarkdown('italic', 'contenido_sobre_mi')" title="Cursiva"><i>I</i></button>
                        <button onclick="applyMarkdown('strike', 'contenido_sobre_mi')" title="Tachado"><s>S</s></button>
                        <button onclick="applyMarkdown('link', 'contenido_sobre_mi')" title="Enlace">Enlace</button>
                        <button onclick="applyMarkdown('image', 'contenido_sobre_mi')" title="Insertar URL de Imagen">Imagen</button>
                        <button onclick="applyMarkdown('imgbb-image', 'contenido_sobre_mi')" title="Subir Imagen a ImgBB">ImgBB</button>
                        <button onclick="applyMarkdown('download-image', 'contenido_sobre_mi')" title="Imagen con Descarga (URL)">[Img-DL]</button>
                        <button onclick="applyMarkdown('imgbb-link-image', 'contenido_sobre_mi')" title="Subir Imagen con Enlace (ImgBB)">[ImgBB+Link]</button>
                        <button onclick="applyMarkdown('quote', 'contenido_sobre_mi')" title="Cita">Cita</button>
                        <button onclick="applyMarkdown('code_block', 'contenido_sobre_mi')" title="Bloque de Código">Bloque</button>
                        <button onclick="applyMarkdown('hr', 'contenido_sobre_mi')" title="Línea horizontal">Línea</button>
                        <button onclick="applyMarkdown('h2', 'contenido_sobre_mi')" title="Título 2">Tít 2</button>
                        <button onclick="applyMarkdown('h3', 'contenido_sobre_mi')" title="Título 3">Tít 3</button>
                        <button onclick="applyMarkdown('ul', 'contenido_sobre_mi')" title="Lista">Lista</button>
                        <button onclick="applyMarkdown('ol', 'contenido_sobre_mi')" title="Lista Num.">Lista Num.</button>
                    </div>
                    <textarea id="contenido_sobre_mi" oninput="updatePreview()"></textarea>
                    <button class="save-button" onclick="saveAboutMe()">Guardar y Descargar info.json</button>
                </fieldset>
            </div>
        </div>
        <div class="preview-pane">
            <div class="preview-switcher">
                <button id="btn-list-view" class="active" onclick="switchToListView()">Vista Tarjetas</button>
                <button id="btn-detail-view" onclick="switchToDetailView()">Vista Detalle</button>
                <button id="btn-about-view" onclick="switchToAboutView()">Vista 'Sobre Mí'</button>
            </div>
            <iframe id="preview-frame" src="index.html"></iframe>
        </div>
    </div>
    <input type="file" id="image-uploader" accept="image/*" style="display: none;">

    <script>
        // --- CONFIGURACIÓN DE IMGBB ---
        const IMGBB_API_KEY = 'b8a4f499248761bcdc6789718a1eb1d2';
        
        let currentProjects = []; let aboutMeContent = { contenido: '' };
        let editingIndex = -1; let previewMode = 'list';
        const previewFrame = document.getElementById('preview-frame');
        const manageList = document.getElementById('manage-list');

        function validateId() {
            const idInput = document.getElementById('id');
            const idError = document.getElementById('id-error');
            const currentId = idInput.value.trim();

            if (!currentId) {
                idInput.classList.remove('error');
                idError.textContent = '';
                return;
            }

            const isDuplicate = currentProjects.some((project, index) => {
                return index !== editingIndex && project.id === currentId;
            });

            if (isDuplicate) {
                idInput.classList.add('error');
                idError.textContent = 'Este ID ya existe.';
            } else {
                idInput.classList.remove('error');
                idError.textContent = '';
            }
        }
        
        // --- LÓGICA DE SUBIDA A IMGBB ---
        function triggerUpload(targetId, type) {
            if (IMGBB_API_KEY === 'TU_API_KEY_DE_IMGBB_AQUI' || !IMGBB_API_KEY) {
                alert('Error: Debes configurar tu clave API de ImgBB en el archivo panel.html');
                return;
            }
            const uploader = document.getElementById('image-uploader');
            
            uploader.onchange = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                if (type === 'input') {
                    uploadForInput(file, targetId);
                } else if (type === 'markdown-image' || type === 'markdown-link-image') {
                    uploadForMarkdown(file, targetId, type);
                }
            };
            
            uploader.click();
        }

        async function uploadForInput(file, inputId) {
            const button = document.querySelector(`button[onclick*="'${inputId}'"]`);
            const originalText = button.innerHTML;
            button.innerHTML = 'Subiendo...';
            button.disabled = true;

            try {
                const imgUrl = await uploadToImgBB(file);
                document.getElementById(inputId).value = imgUrl;
                updatePreview();
            } catch (error) {
                alert(`Error al subir a ImgBB: ${error.message}`);
            } finally {
                button.innerHTML = 'Subir a ImgBB';
                button.disabled = false;
                document.getElementById('image-uploader').value = '';
            }
        }

        async function uploadForMarkdown(file, textareaId, type) {
            const buttonSelector = `button[onclick*="'${type}', '${textareaId}'"]`;
            const button = document.querySelector(buttonSelector);
            const originalText = button.innerHTML;
            button.innerHTML = 'Subiendo...';
            button.disabled = true;

            try {
                const imgUrl = await uploadToImgBB(file);
                let finalMarkdown = `![alt text](${imgUrl})`;

                if (type === 'markdown-link-image') {
                    const destUrl = prompt('URL de destino (el enlace de descarga):', 'https://');
                    if (destUrl) {
                        finalMarkdown = `[${finalMarkdown}](${destUrl})`;
                    }
                }
                
                insertAtCursor(textareaId, finalMarkdown);
                updatePreview();

            } catch (error) {
                alert(`Error al subir a ImgBB: ${error.message}`);
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
                document.getElementById('image-uploader').value = '';
            }
        }

        async function uploadToImgBB(file) {
            const formData = new FormData();
            formData.append('image', file);
            
            const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            if (!response.ok || !data.success) {
                throw new Error(data.error?.message || 'Error desconocido en la API de ImgBB');
            }
            return data.data.url;
        }
        
        function insertAtCursor(textareaId, text) {
            const textarea = document.getElementById(textareaId);
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            textarea.value = textarea.value.substring(0, start) + text + textarea.value.substring(end);
            textarea.focus();
            textarea.selectionEnd = start + text.length;
        }

        function applyMarkdown(type, textareaId) {
            if (type === 'imgbb-image') {
                triggerUpload(textareaId, 'markdown-image');
                return;
            }
            if (type === 'imgbb-link-image') {
                triggerUpload(textareaId, 'markdown-link-image');
                return;
            }

            const textarea = document.getElementById(textareaId);
            const selectedText = textarea.value.substring(textarea.selectionStart, textarea.selectionEnd);
            let markdownText = '', preText = '', postText = '';

            switch(type) {
                case 'bold': preText = '**'; postText = '**'; break;
                case 'italic': preText = '*'; postText = '*'; break;
                case 'strike': preText = '~~'; postText = '~~'; break;
                case 'h2': preText = '\n## '; postText = '\n'; break;
                case 'h3': preText = '\n### '; postText = '\n'; break;
                case 'link': 
                    const url = prompt('Introduce la URL del enlace:', 'https://');
                    if (url) { preText = '['; postText = `](${url})`; }
                    break;
                case 'image': 
                    const imgUrl = prompt('URL de la imagen:', 'https://');
                    if (imgUrl) { markdownText = `![${selectedText || 'alt text'}](${imgUrl})`; }
                    break;
                case 'download-image':
                    const d_imgUrl = prompt('URL de la IMAGEN:', 'https://');
                    if(d_imgUrl){
                        const d_downloadUrl = prompt('URL del ARCHIVO a descargar:');
                        if(d_downloadUrl) { 
                            markdownText = `[IMAGEN-DESCARGA](${d_imgUrl}, ${d_downloadUrl})`;
                        }
                    }
                    break;
                case 'ul': markdownText = `\n- Punto 1\n- Punto 2`; break;
                case 'ol': markdownText = `\n1. Punto 1\n2. Punto 2`; break;
                case 'quote': preText = '\n> '; postText = '\n'; break;
                case 'code_block':
                    const lang = prompt('¿Qué lenguaje de programación? (ej: python, csharp, javascript, css...)', 'python');
                    markdownText = "\n```" + lang + "\n" + (selectedText || 'tu código aquí') + "\n```\n";
                    break;
                case 'hr': markdownText = `\n\n---\n\n`; break;
            }

            if (preText || postText || markdownText) {
                let finalText = markdownText;
                if (!finalText) {
                    finalText = preText + (selectedText || (type === 'link' ? 'texto' : '')) + postText;
                }
                insertAtCursor(textareaId, finalText);
                updatePreview();
            }
        }

        function loadInitialData(){
            fetch('proyectos.json').then(r=>r.json()).then(d=>{currentProjects=d.items||[];renderManageList();Sortable.create(manageList,{animation:150,handle:'.drag-handle',onEnd:function(e){const n=[...manageList.querySelectorAll('.manage-item')].map(t=>t.dataset.id).reverse();currentProjects.sort((t,a)=>n.indexOf(t.id)-n.indexOf(a.id));renderManageList();updatePreview(true)}})});
            fetch('info.json').then(r=>r.json()).then(d=>{aboutMeContent=d;document.getElementById('contenido_sobre_mi').value=aboutMeContent.contenido||''}).catch(e=>console.log("info.json no encontrado, se creará uno nuevo."));
            previewFrame.onload=()=>updatePreview(true);
            if(document.readyState==="complete"){updatePreview(true)}
        }
        
        function renderManageList(){
            const c=document.getElementById('manage-list');c.innerHTML='';if(currentProjects.length===0){c.innerHTML='<p>No hay proyectos.</p>';return}
            [...currentProjects].reverse().forEach((p,i)=>{const o=currentProjects.length-1-i;const t=document.createElement('div');t.className='manage-item';t.dataset.id=p.id;t.innerHTML=`<span class="drag-handle">::</span><span class="manage-item-title">${p.titulo}</span><div class="manage-buttons"><button class="duplicate-button" onclick="duplicateProjectById('${p.id}')">Duplicar</button><button class="edit-button" onclick="editProjectById('${p.id}')">Editar</button><button class="delete-button" onclick="deleteProjectById('${p.id}')">Borrar</button></div>`;c.appendChild(t)})
        }
        
        function findProjectIndexById(i){return currentProjects.findIndex(p=>p.id===i)}
        
        function duplicateProjectById(i){
            const d=findProjectIndexById(i);if(d===-1)return;const p=JSON.parse(JSON.stringify(currentProjects[d]));p.titulo+=" (Copia)";p.id+="-copia-"+Date.now();currentProjects.push(p);renderManageList();updatePreview(true);alert(`Duplicado.`)
        }
        
        function editProjectById(i){
            const d=findProjectIndexById(i);if(d===-1)return;editingIndex=d;const p=currentProjects[d];document.getElementById('titulo').value=p.titulo;document.getElementById('id').value=p.id;document.getElementById('resumen').value=p.resumen;document.getElementById('contenido_completo').value=p.contenido_completo;document.getElementById('imagen').value=p.imagen;document.getElementById('enlace').value=p.enlace||'';document.getElementById('tags').value=(p.tags||[]).join(', ');
            validateId();document.getElementById('main-button').innerText='Guardar Cambios';document.getElementById('cancel-button').style.display='block';window.scrollTo(0,0);switchToDetailView()
        }
        
        function deleteProjectById(i){
            const d=findProjectIndexById(i);if(d===-1)return;if(confirm(`¿Borrar "${currentProjects[d].titulo}"?`)){currentProjects.splice(d,1);renderManageList();updatePreview(true);alert('Proyecto borrado.')}
        }
        
        function getProjectFromForm(){
            const t=document.getElementById('tags').value;return{titulo:document.getElementById('titulo').value,id:document.getElementById('id').value,resumen:document.getElementById('resumen').value,contenido_completo:document.getElementById('contenido_completo').value,imagen:document.getElementById('imagen').value,enlace:document.getElementById('enlace').value,tags:t?t.split(',').map(g=>g.trim()):[]}
        }
        
        function updatePreview(forceProjectList = false) {
            // -- INICIO DE LA CORRECCIÓN --
            if (!previewFrame.contentWindow) return; // Salir si el iframe no está listo
            
            try {
                if (previewMode === 'list') {
                    const p = getProjectFromForm();
                    let l = [...currentProjects];
                    if (editingIndex > -1 && !forceProjectList) { 
                        l[editingIndex] = p; 
                    } else if (editingIndex === -1 && !forceProjectList && p.titulo) { 
                        // Corregido: solo añadir si NO estamos editando y hay un título
                        l.push(p); 
                    }
                    previewFrame.contentWindow.postMessage({ type: 'previewUpdate', payload: l }, '*');
                } else if (previewMode === 'detail') {
                    const d = (editingIndex > -1 && !forceProjectList) ? currentProjects[editingIndex] : getProjectFromForm();
                    previewFrame.contentWindow.postMessage({ type: 'detailPreviewUpdate', payload: d }, '*');
                } else if (previewMode === 'about') {
                     previewFrame.contentWindow.postMessage({ type: 'aboutPreviewUpdate', payload: document.getElementById('contenido_sobre_mi').value }, '*');
                }
            } catch(e) {
                console.warn("Error de seguridad al acceder al iframe (probablemente esté cargando). Se reintentará pronto.", e);
            }
            // -- FIN DE LA CORRECCIÓN --
        }

        function setActiveView(view) {
            previewMode = view;
            ['btn-list-view', 'btn-detail-view', 'btn-about-view'].forEach(id => {
                const button = document.getElementById(id);
                button.classList.toggle('active', button.id.startsWith('btn-' + view));
            });
        }
        
        function switchToListView() {
            setActiveView('list');
            if (!previewFrame.src.includes('index.html')) {
                previewFrame.src = 'index.html';
                previewFrame.onload = () => updatePreview(true);
            } else { updatePreview(true); }
        }
        
        function switchToDetailView() {
            setActiveView('detail');
            if (!previewFrame.src.includes('proyecto.html')) {
                previewFrame.src = 'proyecto.html';
                previewFrame.onload = () => updatePreview();
            } else { updatePreview(); }
        }

        function switchToAboutView() {
            setActiveView('about');
            if (!previewFrame.src.includes('sobre-mi.html')) {
                previewFrame.src = 'sobre-mi.html';
                previewFrame.onload = () => updatePreview();
            } else { updatePreview(); }
        }
        
        function cancelEdit(){
            editingIndex=-1;clearForm();document.getElementById('main-button').innerText='Añadir Proyecto';document.getElementById('cancel-button').style.display='none';switchToListView();
        }
        
        function submitProject(){
            const p=getProjectFromForm();if(!p.titulo||!p.id||!p.resumen||!p.contenido_completo||!p.imagen){alert('Faltan campos obligatorios.');return}
            const isDuplicate=currentProjects.some((project,index)=>index!==editingIndex&&project.id===p.id);if(isDuplicate){alert('El ID del proyecto ya está en uso. Por favor, elige un ID único.');document.getElementById('id').focus();return}
            if(editingIndex>-1){currentProjects[editingIndex]=p;alert('Proyecto actualizado.');cancelEdit()}else{currentProjects.push(p);alert('Proyecto añadido.');clearForm()}
            renderManageList();updatePreview(true)
        }
        
        function saveProjects(){
            const f=JSON.stringify({items:currentProjects},null,2);const b=new Blob([f],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='proyectos.json';a.click();URL.revokeObjectURL(a.href)
        }

        function saveAboutMe(){
            const c={contenido:document.getElementById('contenido_sobre_mi').value};const f=JSON.stringify(c,null,2);const b=new Blob([f],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='info.json';a.click();URL.revokeObjectURL(a.href)
        }
        
        function clearForm(){
            document.getElementById('titulo').value='';document.getElementById('id').value='';document.getElementById('resumen').value='';document.getElementById('contenido_completo').value='';document.getElementById('imagen').value='';document.getElementById('enlace').value='';document.getElementById('tags').value='';validateId();
        }

        loadInitialData();
    </script>
</body>
</html>
