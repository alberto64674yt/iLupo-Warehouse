<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF--8">
    <title>Panel de Control - iLupo Warehouse</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="/favicon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon/favicon.svg" />
    <link rel="shortcut icon" href="/favicon/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
    <link rel="manifest" href="/favicon/site.webmanifest" />
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
	<style>
        /* Estilos para pestañas de idioma */
        .lang-tabs {
            display: flex;
            margin-bottom: -1px; /* Para que se solape con el borde del campo de texto */
        }
        .lang-tab {
            padding: 8px 15px;
            cursor: pointer;
            border: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            background-color: var(--surface-color);
            border-radius: 8px 8px 0 0;
            margin-right: 5px;
            color: var(--light-text);
        }
        .lang-tab.active {
            background-color: var(--dark-bg);
            border-bottom: 1px solid var(--dark-bg);
            color: var(--primary-color);
            font-weight: bold;
        }
        .lang-pane {
            display: none;
            /* El borde superior se lo dará el campo de texto de dentro */
        }
        .lang-pane.active {
            display: block;
        }
        /* Pequeño ajuste para los inputs dentro de las pestañas */
        .lang-pane input, .lang-pane textarea {
            border-top-left-radius: 0;
        }
    </style>
</head>
<body class="panel-body">
    <div class="panel-container">
        <div class="editor-pane">
            <div id="admin-panel">
                <a href="index.html" class="back-to-site-button">← Volver a la Web Principal</a>
                <h1>Panel de Control</h1>
                
                <fieldset>
                    <legend>Gestionar Proyectos</legend>
                    <div class="form-section">
                        <label>Título del Proyecto</label>
                        <div class="lang-tabs">
                            <div class="lang-tab active" data-lang="es" data-field="titulo">Español</div>
                            <div class="lang-tab" data-lang="en" data-field="titulo">Inglés</div>
                        </div>
                        <div id="pane-titulo-es" class="lang-pane active">
                            <input type="text" id="titulo_es" oninput="updatePreview()" placeholder="Título en español">
                        </div>
                        <div id="pane-titulo-en" class="lang-pane">
                            <input type="text" id="titulo_en" oninput="updatePreview()" placeholder="Título en inglés">
                        </div>
                        <label for="id">ID para la URL (ej: mi-proyecto-1)</label>
                        <input type="text" id="id" oninput="updatePreview(); validateId();">
                        <small id="id-error" style="color: var(--danger-color); margin-top: -0.75rem; display: block; height: 1rem;"></small>
                        <label>Resumen Corto (para la tarjeta)</label>
                        <div class="lang-tabs">
                            <div class="lang-tab active" data-lang="es" data-field="resumen">Español</div>
                            <div class="lang-tab" data-lang="en" data-field="resumen">Inglés</div>
                        </div>
                        <div id="pane-resumen-es" class="lang-pane active">
                            <textarea id="resumen_es" oninput="updatePreview()" placeholder="Resumen en español"></textarea>
                        </div>
                        <div id="pane-resumen-en" class="lang-pane">
                            <textarea id="resumen_en" oninput="updatePreview()" placeholder="Resumen en inglés"></textarea>
                        </div>
                        <label for="imagen">URL de la Imagen Principal</label>
                        <input type="text" id="imagen" oninput="updatePreview()">
                        <button class="upload-button" onclick="triggerUpload('imagen', 'input')">Subir a ImgBB</button>

                        <label for="tags">Etiquetas (separadas por comas)</label>
                        <input type="text" id="tags" placeholder="Ej: Programación > Python, Juegos > Minecraft > Mods" oninput="updatePreview()">
                        <label>Descripción Completa (Markdown)</label>
                        <div class="lang-tabs">
                            <div class="lang-tab active" data-lang="es" data-field="contenido_completo">Español</div>
                            <div class="lang-tab" data-lang="en" data-field="contenido_completo">Inglés</div>
                        </div>
                        <div id="pane-contenido_completo-es" class="lang-pane active">
                            <div class="markdown-toolbar">
                                <button onclick="applyMarkdown('bold', 'contenido_completo_es')" title="Negrita"><b>B</b></button>
                                <button onclick="applyMarkdown('italic', 'contenido_completo_es')" title="Cursiva"><i>I</i></button>
                                <button onclick="applyMarkdown('strike', 'contenido_completo_es')" title="Tachado"><s>S</s></button>
                                <button onclick="applyMarkdown('link', 'contenido_completo_es')" title="Enlace">Enlace</button>
                                <button onclick="applyMarkdown('image', 'contenido_completo_es')" title="Insertar URL de Imagen">Imagen</button>
                                <button onclick="applyMarkdown('imgbb-image', 'contenido_completo_es')" title="Subir Imagen a ImgBB">ImgBB</button>
                                <button onclick="applyMarkdown('download-image', 'contenido_completo_es')" title="Imagen con Descarga (URL)">[Img-DL]</button>
                                <button onclick="applyMarkdown('imgbb-link-image', 'contenido_completo_es')" title="Subir Imagen con Enlace (ImgBB)">[ImgBB+Link]</button>
                                <button onclick="applyMarkdown('quote', 'contenido_completo_es')" title="Cita">Cita</button>
                                <button onclick="applyMarkdown('code_block', 'contenido_completo_es')" title="Bloque de Código">Bloque</button>
                                <button onclick="applyMarkdown('hr', 'contenido_completo_es')" title="Línea horizontal">Línea</button>
                                <button onclick="applyMarkdown('alert', 'contenido_completo_es')" title="Caja de Alerta">Alerta</button>
                                <button onclick="applyMarkdown('spoiler', 'contenido_completo_es')" title="Contenido Desplegable">Spoiler</button>
                                <button onclick="applyMarkdown('tabs', 'contenido_completo_es')" title="Pestañas">Tabs</button>
                                <button onclick="applyMarkdown('table', 'contenido_completo_es')" title="Tabla">Tabla</button>
                                <button onclick="applyMarkdown('h2', 'contenido_completo_es')" title="Título 2">Tít 2</button>
                                <button onclick="applyMarkdown('h3', 'contenido_completo_es')" title="Título 3">Tít 3</button>
                                <button onclick="applyMarkdown('ul', 'contenido_completo_es')" title="Lista">Lista</button>
                                <button onclick="applyMarkdown('ol', 'contenido_completo_es')" title="Lista Num.">Lista Num.</button>
                            </div>
                            <textarea id="contenido_completo_es" oninput="updatePreview()" placeholder="Descripción en español"></textarea>
                        </div>
                        <div id="pane-contenido_completo-en" class="lang-pane">
                            <div class="markdown-toolbar">
                                <button onclick="applyMarkdown('bold', 'contenido_completo_en')" title="Negrita"><b>B</b></button>
                                <button onclick="applyMarkdown('italic', 'contenido_completo_en')" title="Cursiva"><i>I</i></button>
                                <button onclick="applyMarkdown('strike', 'contenido_completo_en')" title="Tachado"><s>S</s></button>
                                <button onclick="applyMarkdown('link', 'contenido_completo_en')" title="Enlace">Enlace</button>
                                <button onclick="applyMarkdown('image', 'contenido_completo_en')" title="Insertar URL de Imagen">Imagen</button>
                                <button onclick="applyMarkdown('imgbb-image', 'contenido_completo_en')" title="Subir Imagen a ImgBB">ImgBB</button>
                                <button onclick="applyMarkdown('download-image', 'contenido_completo_en')" title="Imagen con Descarga (URL)">[Img-DL]</button>
                                <button onclick="applyMarkdown('imgbb-link-image', 'contenido_completo_en')" title="Subir Imagen con Enlace (ImgBB)">[ImgBB+Link]</button>
                                <button onclick="applyMarkdown('quote', 'contenido_completo_en')" title="Cita">Cita</button>
                                <button onclick="applyMarkdown('code_block', 'contenido_completo_en')" title="Bloque de Código">Bloque</button>
                                <button onclick="applyMarkdown('hr', 'contenido_completo_en')" title="Línea horizontal">Línea</button>
                                <button onclick="applyMarkdown('alert', 'contenido_completo_en')" title="Caja de Alerta">Alerta</button>
                                <button onclick="applyMarkdown('spoiler', 'contenido_completo_en')" title="Contenido Desplegable">Spoiler</button>
                                <button onclick="applyMarkdown('tabs', 'contenido_completo_en')" title="Pestañas">Tabs</button>
                                <button onclick="applyMarkdown('table', 'contenido_completo_en')" title="Tabla">Tabla</button>
                                <button onclick="applyMarkdown('h2', 'contenido_completo_en')" title="Título 2">Tít 2</button>
                                <button onclick="applyMarkdown('h3', 'contenido_completo_en')" title="Título 3">Tít 3</button>
                                <button onclick="applyMarkdown('ul', 'contenido_completo_en')" title="Lista">Lista</button>
                                <button onclick="applyMarkdown('ol', 'contenido_completo_en')" title="Lista Num.">Lista Num.</button>
                            </div>
                            <textarea id="contenido_completo_en" oninput="updatePreview()" placeholder="Descripción en inglés"></textarea>
                        </div>
                        <label for="enlace">URL del Botón Principal (opcional)</label>
                        <input type="text" id="enlace" oninput="updatePreview()">
                    </div>
                    <div class="form-actions">
                        <button id="main-button" onclick="submitProject()">Añadir Proyecto</button>
                        <button id="cancel-button" onclick="cancelEdit()" style="display:none;">Cancelar</button>
                    </div>
                </fieldset>

                <div class="manage-container">
                    <h2>Proyectos Existentes</h2>
                    <div class="search-manage-container">
                        <label for="manage-search-box">Buscar proyecto para mover o editar...</label>
                        <input type="text" id="manage-search-box" placeholder="Escribe para buscar...">
                    </div>
                    <div id="search-results-list"></div>
                    <hr style="margin: 1.5rem 0;">
                    <h3 style="margin-top:0;">Lista Completa (Arrastra para ordenar)</h3>
                    <div id="manage-list"></div>
                </div>
                <hr>
                <div class="save-container">
                    <button class="save-button" onclick="saveProjects()">Generar y Descargar proyectos.json</button>
                </div>
                <hr>
                 <fieldset>
                    <legend>Editar Página "Sobre Mí"</legend>
                    <label for="contenido_sobre_mi">Contenido de la página (Markdown)</label>
                    <div class="markdown-toolbar">
                        <button onclick="applyMarkdown('bold', 'contenido_sobre_mi')" title="Negrita"><b>B</b></button>
                        <button onclick="applyMarkdown('italic', 'contenido_sobre_mi')" title="Cursiva"><i>I</i></button>
                        <button onclick="applyMarkdown('strike', 'contenido_sobre_mi')" title="Tachado"><s>S</s></button>
                        <button onclick="applyMarkdown('link', 'contenido_sobre_mi')" title="Enlace">Enlace</button>
                        <button onclick="applyMarkdown('image', 'contenido_sobre_mi')" title="Insertar URL de Imagen">Imagen</button>
                        <button onclick="applyMarkdown('imgbb-image', 'contenido_sobre_mi')" title="Subir Imagen a ImgBB">ImgBB</button>
                        <button onclick="applyMarkdown('download-image', 'contenido_sobre_mi')" title="Imagen con Descarga (URL)">[Img-DL]</button>
                        <button onclick="applyMarkdown('imgbb-link-image', 'contenido_sobre_mi')" title="Subir Imagen con Enlace (ImgBB)">[ImgBB+Link]</button>
                        <button onclick="applyMarkdown('quote', 'contenido_sobre_mi')" title="Cita">Cita</button>
                        <button onclick="applyMarkdown('code_block', 'contenido_sobre_mi')" title="Bloque de Código">Bloque</button>
                        <button onclick="applyMarkdown('hr', 'contenido_sobre_mi')" title="Línea horizontal">Línea</button>
                        <button onclick="applyMarkdown('alert', 'contenido_sobre_mi')" title="Caja de Alerta">Alerta</button>
                        <button onclick="applyMarkdown('spoiler', 'contenido_sobre_mi')" title="Contenido Desplegable">Spoiler</button>
                        <button onclick="applyMarkdown('tabs', 'contenido_sobre_mi')" title="Pestañas">Tabs</button>
                        <button onclick="applyMarkdown('table', 'contenido_sobre_mi')" title="Tabla">Tabla</button>
                        <button onclick="applyMarkdown('h2', 'contenido_sobre_mi')" title="Título 2">Tít 2</button>
                        <button onclick="applyMarkdown('h3', 'contenido_sobre_mi')" title="Título 3">Tít 3</button>
                        <button onclick="applyMarkdown('ul', 'contenido_sobre_mi')" title="Lista">Lista</button>
                        <button onclick="applyMarkdown('ol', 'contenido_sobre_mi')" title="Lista Num.">Lista Num.</button>
                    </div>
                    <textarea id="contenido_sobre_mi" oninput="updatePreview()"></textarea>
                    <button class="save-button" onclick="saveAboutMe()">Guardar y Descargar info.json</button>
                </fieldset>
            </div>
        </div>
        <div class="preview-pane">
            <div class="preview-switcher">
                <button id="btn-list-view" class="active" onclick="switchToListView()">Vista Tarjetas</button>
                <button id="btn-detail-view" onclick="switchToDetailView()">Vista Detalle</button>
                <button id="btn-about-view" onclick="switchToAboutView()">Vista 'Sobre Mí'</button>
            </div>
            <iframe id="preview-frame" src="index.html"></iframe>
        </div>
    </div>
    <input type="file" id="image-uploader" accept="image/*" style="display: none;">

    <script>
        const IMGBB_API_KEY = 'b8a4f499248761bcdc6789718a1eb1d2';
		let sitemapNeedsUpdate = false;
        
        let currentProjects = []; let aboutMeContent = { contenido: '' };
        let editingIndex = -1; let previewMode = 'list';
        const previewFrame = document.getElementById('preview-frame');
        const manageList = document.getElementById('manage-list');
        // --- INICIO: NUEVOS ELEMENTOS DEL DOM ---
        const searchResultsList = document.getElementById('search-results-list');
        const manageSearchBox = document.getElementById('manage-search-box');
        // --- FIN: NUEVOS ELEMENTOS DEL DOM ---
		function switchLang(field, lang) {
            // Ocultar todos los paneles y quitar 'active' de las pestañas para ese campo
            document.querySelectorAll(`[data-field="${field}"]`).forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll(`[id^="pane-${field}-"]`).forEach(pane => pane.classList.remove('active'));

            // Mostrar el panel y la pestaña seleccionados
            document.querySelector(`[data-field="${field}"][data-lang="${lang}"]`).classList.add('active');
            document.getElementById(`pane-${field}-${lang}`).classList.add('active');
        }

        function validateId() {
            const idInput = document.getElementById('id');
            const idError = document.getElementById('id-error');
            const currentId = idInput.value.trim();
            if (!currentId) { idInput.classList.remove('error'); idError.textContent = ''; return; }
            const isDuplicate = currentProjects.some((p, i) => i !== editingIndex && p.id === currentId);
            idInput.classList.toggle('error', isDuplicate);
            idError.textContent = isDuplicate ? 'Este ID ya existe.' : '';
        }
        
        function triggerUpload(targetId, type) {
            if (IMGBB_API_KEY === 'TU_API_KEY_DE_IMGBB_AQUI' || !IMGBB_API_KEY) {
                return alert('Error: Debes configurar tu clave API de ImgBB en el archivo panel.html');
            }
            const uploader = document.getElementById('image-uploader');
            uploader.onchange = e => {
                const file = e.target.files[0];
                if (file) {
                    if (type === 'input') uploadForInput(file, targetId);
                    else if (type === 'markdown-image' || type === 'markdown-link-image') uploadForMarkdown(file, targetId, type);
                }
            };
            uploader.click();
        }

        async function uploadToImgBB(file) {
            const formData = new FormData();
            formData.append('image', file);
            const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData });
            const data = await response.json();
            if (!response.ok || !data.success) throw new Error(data.error?.message || 'Error en la API de ImgBB');
            return data.data.url;
        }

        async function performUpload(file, button, task) {
            const originalText = button ? button.innerHTML : '';
            if (button) { button.innerHTML = 'Subiendo...'; button.disabled = true; }
            try {
                const imgUrl = await uploadToImgBB(file);
                await task(imgUrl);
            } catch (error) {
                alert(`Error al subir a ImgBB: ${error.message}`);
            } finally {
                if (button) { button.innerHTML = originalText; button.disabled = false; }
                document.getElementById('image-uploader').value = '';
            }
        }

        function uploadForInput(file, inputId) {
            const button = document.querySelector(`button.upload-button`);
            performUpload(file, button, (imgUrl) => {
                document.getElementById(inputId).value = imgUrl;
                updatePreview();
            });
        }

        function uploadForMarkdown(file, textareaId, type) {
            const button = document.querySelector(`button[onclick*="'${type}', '${textareaId}'"]`);
            performUpload(file, button, (imgUrl) => {
                let finalMarkdown = `![alt text](${imgUrl})`;
                if (type === 'markdown-link-image') {
                    const destUrl = prompt('URL de destino (el enlace de descarga):', 'https://');
                    if (destUrl) finalMarkdown = `[${finalMarkdown}](${destUrl})`;
                }
                insertAtCursor(textareaId, finalMarkdown);
                updatePreview();
            });
        }
        
        function insertAtCursor(textareaId, text) {
            const textarea = document.getElementById(textareaId);
            const start = textarea.selectionStart, end = textarea.selectionEnd;
            textarea.value = textarea.value.substring(0, start) + text + textarea.value.substring(end);
            textarea.focus();
            textarea.selectionEnd = start + text.length;
        }

        function applyMarkdown(type, textareaId) {
            if (type.startsWith('imgbb-')) {
                triggerUpload(textareaId, type.replace('imgbb-', 'markdown-'));
                return;
            }
            const textarea = document.getElementById(textareaId);
            const selectedText = textarea.value.substring(textarea.selectionStart, textarea.selectionEnd);
            let markdownText = '', preText = '', postText = '';
            
            switch(type) {
                case 'alert':
                    let alertType = prompt("Introduce el tipo de alerta (nota, aviso, info):", "info");
                    if (['nota', 'aviso', 'info'].includes(alertType)) {
                        markdownText = `\n[${alertType}]\n${selectedText || 'Texto de la alerta...'}\n[/${alertType}]\n`;
                    } else {
                        alert("Tipo de alerta no válido. Usa 'nota', 'aviso' o 'info'.");
                    }
                    break;
                case 'spoiler':
                    const spoilerTitle = prompt("Introduce el título del spoiler (lo que se ve antes de hacer clic):", "Haz clic para mostrar");
                    if (spoilerTitle) {
                        markdownText = `\n[spoiler:${spoilerTitle}]\n${selectedText || 'Contenido oculto...'}\n[/spoiler]\n`;
                    }
                    break;
                case 'tabs':
                    const numTabs = parseInt(prompt("¿Cuántas pestañas quieres crear?", "3"));
                    if (numTabs > 0) {
                        let tabsContent = '\n[tabs]\n';
                        for (let i = 1; i <= numTabs; i++) {
                            tabsContent += `[tab:Pestaña ${i}]\nContenido de la pestaña ${i}...\n`;
                        }
                        tabsContent += '[/tabs]\n';
                        markdownText = tabsContent;
                    } else {
                        alert("El número de pestañas debe ser mayor que cero.");
                    }
                    break;
                case 'table':
                    const dims = prompt("Introduce las dimensiones (Columnas x Filas):\n\n- Columnas: de izquierda a derecha\n- Filas: de arriba a abajo", "3x4");
                    if (dims) {
                        const parts = dims.toLowerCase().split('x');
                        if (parts.length === 2) {
                            const cols = parseInt(parts[0]);
                            const rows = parseInt(parts[1]);
                            if (cols > 0 && rows > 0) {
                                let header = '|', divider = '|', tableRows = '';
                                for(let i = 0; i < cols; i++) {
                                    header += ` Encabezado ${i+1} |`;
                                    divider += `---|`;
                                }
                                for (let r = 0; r < rows; r++) {
                                    let row = '|';
                                    for (let c = 0; c < cols; c++) {
                                        row += ` Celda ${c+1} |`;
                                    }
                                    tableRows += row + '\n';
                                }
                                markdownText = `\n${header}\n${divider}\n${tableRows}`;
                            } else { alert("Las dimensiones deben ser números mayores que cero."); }
                        } else { alert("Formato incorrecto. Usa el formato 'Columnas x Filas', por ejemplo: 4x5.");}
                    }
                    break;
                case 'bold': preText = '**'; postText = '**'; break;
                case 'italic': preText = '*'; postText = '*'; break;
                case 'strike': preText = '~~'; postText = '~~'; break;
                case 'h2': preText = '\n## '; postText = '\n'; break;
                case 'h3': preText = '\n### '; postText = '\n'; break;
                case 'link': 
                    const url = prompt('Introduce la URL del enlace:', 'https://');
                    if (url) { preText = '['; postText = `](${url})`; }
                    break;
                case 'image': 
                    const imgUrl = prompt('URL de la imagen:', 'https://');
                    if (imgUrl) markdownText = `![${selectedText || 'alt text'}](${imgUrl})`;
                    break;
                case 'download-image':
                    const d_imgUrl = prompt('URL de la IMAGEN:', 'https://');
                    if(d_imgUrl){
                        const d_downloadUrl = prompt('URL del ARCHIVO a descargar:');
                        if(d_downloadUrl) { markdownText = `[IMAGEN-DESCARGA](${d_imgUrl}, ${d_downloadUrl})`; }
                    }
                    break;
                case 'ul': markdownText = `\n- Punto 1\n- Punto 2`; break;
                case 'ol': markdownText = `\n1. Punto 1\n2. Punto 2`; break;
                case 'quote': preText = '\n> '; postText = '\n'; break;
                case 'code_block':
                    const lang = prompt('¿Qué lenguaje de programación? (ej: python, csharp, javascript, css...)', 'python');
                    markdownText = "\n```" + lang + "\n" + (selectedText || 'tu código aquí') + "\n```\n";
                    break;
                case 'hr': markdownText = `\n\n---\n\n`; break;
            }
            if (preText || postText || markdownText) {
                let finalText = markdownText || preText + (selectedText || (type === 'link' ? 'texto' : '')) + postText;
                insertAtCursor(textareaId, finalText);
                updatePreview();
            }
        }
        
        // --- INICIO: LÓGICA DE GESTIÓN DE PROYECTOS (MODIFICADA) ---
        function loadInitialData(){
            fetch('proyectos.json').then(r=>r.json()).then(d=>{
                currentProjects=d.items||[];
                renderManageList();
                
                Sortable.create(searchResultsList, {
                    group: { name: 'projects', pull: 'clone', put: false },
                    animation: 150,
                    sort: false 
                });

                Sortable.create(manageList, {
                    group: 'projects', 
                    animation: 150,
                    handle: '.drag-handle',
                    onEnd: function() { saveOrder(); },
                    onAdd: function(evt) {
                        const allItemsWithId = manageList.querySelectorAll(`.manage-item[data-id="${evt.item.dataset.id}"]`);
                        const originalItem = Array.from(allItemsWithId).find(item => item !== evt.item);
                        if (originalItem) { originalItem.remove(); }
                        saveOrder();
                    }
                });

            });
            fetch('info.json').then(r=>r.json()).then(d=>{aboutMeContent=d;document.getElementById('contenido_sobre_mi').value=aboutMeContent.contenido||''}).catch(e=>console.log("info.json no encontrado."));
            
            document.querySelector('.editor-pane').addEventListener('click', function(e) {
                if (e.target.classList.contains('lang-tab')) {
                    const field = e.target.dataset.field;
                    const lang = e.target.dataset.lang;
                    if (field && lang) { switchLang(field, lang); }
                }
            });
            
            // CORRECCIÓN: Escuchamos el mensaje de 'listo' de la vista previa
            window.addEventListener('message', e => {
                if (e.data.type === 'previewReady') {
                    updatePreview(true);
                }
            });
        }

        function saveOrder() {
            const newOrderIds = [...manageList.querySelectorAll('.manage-item')].map(t => t.dataset.id).reverse();
            currentProjects.sort((a, b) => newOrderIds.indexOf(a.id) - newOrderIds.indexOf(b.id));
            renderManageList(); // Re-renderizar para asegurar consistencia
            updatePreview(true);
        }
        
        function createManageItem(project) {
            const item = document.createElement('div');
            item.className = 'manage-item';
            item.dataset.id = project.id;
            item.innerHTML = `
                <span class="drag-handle">::</span>
                <span class="manage-item-title">${project.titulo.es}</span>
                <div class="manage-buttons">
                    <button class="duplicate-button" onclick="duplicateProjectById('${project.id}')">Duplicar</button>
                    <button class="edit-button" onclick="editProjectById('${project.id}')">Editar</button>
                    <button class="delete-button" onclick="deleteProjectById('${project.id}')">Borrar</button>
                </div>`;
            return item;
        }

        function renderManageList() {
            manageList.innerHTML = '';
            if (currentProjects.length === 0) return manageList.innerHTML = '<p>No hay proyectos.</p>';
            [...currentProjects].reverse().forEach(p => {
                manageList.appendChild(createManageItem(p));
            });
        }

        function renderSearchResults() {
            const searchTerm = manageSearchBox.value.toLowerCase();
            searchResultsList.innerHTML = '';
            if (!searchTerm) return;

            const filteredProjects = currentProjects.filter(p => 
                p.titulo && p.titulo.es && p.titulo.es.toLowerCase().includes(searchTerm)
            );

            if (filteredProjects.length === 0) {
                searchResultsList.innerHTML = '<p class="empty-search-message">No se encontraron proyectos.</p>';
                return;
            }
            filteredProjects.reverse().forEach(p => {
                searchResultsList.appendChild(createManageItem(p));
            });
        }
        
        manageSearchBox.addEventListener('input', renderSearchResults);
        // --- FIN: LÓGICA DE GESTIÓN DE PROYECTOS (MODIFICADA) ---
        
        function findProjectIndexById(i){return currentProjects.findIndex(p=>p.id===i)}
        
        function duplicateProjectById(i){
            const d=findProjectIndexById(i);if(d===-1)return;const p=JSON.parse(JSON.stringify(currentProjects[d]));
            p.titulo.es += " (Copia)";
            if (p.titulo.en) {
                p.titulo.en += " (Copy)";
            }
            p.id+="-copia-"+Date.now();
            currentProjects.push(p);renderManageList();updatePreview(true);
        }
        
        function editProjectById(i){
            const d=findProjectIndexById(i);if(d===-1)return;editingIndex=d;const p=currentProjects[d];
            
            // Rellenar campos bilingües
            document.getElementById('titulo_es').value = p.titulo.es || '';
            document.getElementById('titulo_en').value = p.titulo.en || '';
            document.getElementById('resumen_es').value = p.resumen.es || '';
            document.getElementById('resumen_en').value = p.resumen.en || '';
            document.getElementById('contenido_completo_es').value = p.contenido_completo.es || '';
            document.getElementById('contenido_completo_en').value = p.contenido_completo.en || '';

            // Rellenar campos normales
            document.getElementById('id').value=p.id;
            document.getElementById('imagen').value=p.imagen;
            document.getElementById('enlace').value=p.enlace||'';
            document.getElementById('tags').value=(p.tags||[]).join(', ');

            validateId();
            document.getElementById('main-button').innerText='Guardar Cambios';
            document.getElementById('cancel-button').style.display='block';
            window.scrollTo(0,0);
            switchToDetailView();
        }
        
        function deleteProjectById(i){
            const d=findProjectIndexById(i);if(d===-1)return;if(confirm(`¿Borrar "${currentProjects[d].titulo.es}"?`)){currentProjects.splice(d,1);sitemapNeedsUpdate = true;renderManageList();updatePreview(true);}
        }
        
        function getProjectFromForm(){
            const t=document.getElementById('tags').value;
            return {
                titulo: {
                    es: document.getElementById('titulo_es').value,
                    en: document.getElementById('titulo_en').value
                },
                id: document.getElementById('id').value,
                resumen: {
                    es: document.getElementById('resumen_es').value,
                    en: document.getElementById('resumen_en').value
                },
                contenido_completo: {
                    es: document.getElementById('contenido_completo_es').value,
                    en: document.getElementById('contenido_completo_en').value
                },
                imagen: document.getElementById('imagen').value,
                enlace: document.getElementById('enlace').value,
                tags: t ? t.split(',').map(g=>g.trim()) : []
            }
        }
        
        function updatePreview(forceFullRefresh = false) {
            if (!previewFrame.contentWindow) return;
            try {
                const isLiveTyping = !forceFullRefresh;
                if (previewMode === 'list') {
                    const projectFromForm = getProjectFromForm();
                    let projectsForPreview = [...currentProjects];
                    if (isLiveTyping && editingIndex > -1) {
                        projectsForPreview[editingIndex] = projectFromForm;
                    } 
                    else if (isLiveTyping && editingIndex === -1 && (projectFromForm.titulo.es || projectFromForm.resumen.es)) {
                        projectsForPreview.push(projectFromForm);
                    }
                    previewFrame.contentWindow.postMessage({ type: 'previewUpdate', payload: projectsForPreview, isLive: isLiveTyping }, '*');
                } else if (previewMode === 'detail') {
                    const projectForDetailPreview = getProjectFromForm();
                    previewFrame.contentWindow.postMessage({ type: 'detailPreviewUpdate', payload: projectForDetailPreview }, '*');
                } else if (previewMode === 'about') {
                    const aboutContent = document.getElementById('contenido_sobre_mi').value;
                    previewFrame.contentWindow.postMessage({ type: 'aboutPreviewUpdate', payload: aboutContent }, '*');
                }
            } catch (e) {
                console.warn("No se pudo enviar el mensaje a la vista previa.", e);
            }
        }

        function setActiveView(view) {
            previewMode = view;
            ['btn-list-view', 'btn-detail-view', 'btn-about-view'].forEach(id => {
                document.getElementById(id).classList.toggle('active', id.startsWith('btn-' + view));
            });
        }
        
        function switchToListView() {
            setActiveView('list');
            if (!previewFrame.src.includes('index.html')) {
                previewFrame.src = 'index.html';
                // La lógica 'onload' se elimina, ahora el iframe nos avisará cuando esté listo.
            } else { 
                updatePreview(true); 
            }
        }
        
        function switchToDetailView() {
            setActiveView('detail');
            if (!previewFrame.src.includes('proyecto.html')) {
                previewFrame.src = 'proyecto.html';
                 // La lógica 'onload' se elimina.
            } else { 
                updatePreview(); 
            }
        }

        function switchToAboutView() {
            setActiveView('about');
            if (!previewFrame.src.includes('sobre-mi.html')) {
                previewFrame.src = 'sobre-mi.html';
                previewFrame.onload = () => updatePreview();
            } else { updatePreview(); }
        }
        
        function cancelEdit(){
            editingIndex=-1;clearForm();document.getElementById('main-button').innerText='Añadir Proyecto';document.getElementById('cancel-button').style.display='none';switchToListView();
        }
        
        function submitProject(){
            const p=getProjectFromForm();
            // CORRECCIÓN: La validación ahora comprueba el título en español.
            if(!p.titulo.es||!p.id||!p.resumen.es||!p.contenido_completo.es||!p.imagen){return alert('Faltan campos obligatorios (al menos en español).')}
            if(currentProjects.some((project,index)=>index!==editingIndex&&project.id===p.id)){return alert('El ID del proyecto ya está en uso.')}
            if(editingIndex>-1){currentProjects[editingIndex]=p;alert('Proyecto actualizado.')}else{currentProjects.push(p);sitemapNeedsUpdate = true;alert('Proyecto añadido.')}
            cancelEdit();renderManageList();updatePreview(true)
        }
        
        function saveProjects(){if(sitemapNeedsUpdate){if(confirm('Has añadido o borrado un proyecto. ¿Quieres descargar también el sitemap.xml actualizado?')){generateSitemap();}sitemapNeedsUpdate=false;}const f=JSON.stringify({items:currentProjects},null,2);const b=new Blob([f],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='proyectos.json';a.click();URL.revokeObjectURL(a.href);}
		function generateSitemap(){const today=new Date().toISOString().split('T')[0];const domain='https://ilupowarehouse.netlify.app';let xmlContent=`<?xml version="1.0" encoding="UTF-8"?>\n<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">\n`;xmlContent+=`  <url><loc>${domain}/</loc><lastmod>${today}</lastmod><priority>1.00</priority></url>\n`;xmlContent+=`  <url><loc>${domain}/sobre-mi.html</loc><lastmod>${today}</lastmod><priority>0.80</priority></url>\n`;currentProjects.forEach(project=>{xmlContent+=`  <url><loc>${domain}/proyecto.html?id=${project.id}</loc><lastmod>${today}</lastmod><priority>0.90</priority></url>\n`});const allTags=new Set();currentProjects.forEach(project=>{(project.tags||[]).forEach(fullTagPath=>{fullTagPath.split(' > ').forEach(tagPart=>allTags.add(tagPart.trim()))})});allTags.forEach(tag=>{if(tag){xmlContent+=`  <url><loc>${domain}/tags.html?tag=${encodeURIComponent(tag)}</loc><lastmod>${today}</lastmod><priority>0.70</priority></url>\n`}});xmlContent+='</urlset>';const blob=new Blob([xmlContent],{type:'application/xml'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='sitemap.xml';a.click();URL.revokeObjectURL(a.href);}

        function saveAboutMe(){
            const c={contenido:document.getElementById('contenido_sobre_mi').value};const f=JSON.stringify(c,null,2);const b=new Blob([f],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='info.json';a.click();URL.revokeObjectURL(a.href)
        }
        
        function clearForm(){
            // Limpiar campos bilingües
            ['titulo_es', 'titulo_en', 'resumen_es', 'resumen_en', 'contenido_completo_es', 'contenido_completo_en'].forEach(id => {
                if(document.getElementById(id)) document.getElementById(id).value = '';
            });
            // Limpiar campos únicos
            ['id','imagen','enlace','tags'].forEach(i=>document.getElementById(i).value='');
            validateId();
        }

        loadInitialData();
    </script>
	
	<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js').then(registration => {
        console.log('ServiceWorker registrado con éxito:', registration.scope);
      }).catch(error => {
        console.log('Fallo en el registro del ServiceWorker:', error);
      });
    });
  }
</script>

</body>
</html>


