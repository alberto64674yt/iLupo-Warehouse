<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iLupo Warehouse</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header id="main-header" class="no-select">
        <h1>iLupo Warehouse</h1>
        <p class="subtitle" id="subtitle">
            "Con gran fluidez, mi pequeño workflow exhibe hoy la hazaña de zanjar viejos bugs."
        </p>
    </header>

    <div class="filter-controls">
        <a href="sobre-mi.html" class="about-me-button">Sobre Mí</a>
        <div class="top-controls">
            <div class="search-container">
                <input type="text" id="search-box" placeholder="Buscar por nombre...">
            </div>
            <div class="view-switcher">
                <button id="grid-view-btn" class="view-btn active" title="Vista de Rejilla">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3,3V11H11V3M9,9H5V5H9M3,13V21H11V13M9,19H5V15H9M13,3V11H21V3M19,9H15V5H19M13,13V21H21V13M19,19H15V15H19Z"/></svg>
                </button>
                <button id="list-view-btn" class="view-btn" title="Vista de Lista">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3,4H21V6H3V4M3,11H21V13H3V11M3,18H21V20H3V18Z"/></svg>
                </button>
            </div>
        </div>
        <div id="tag-filter-container" class="tag-filter-container"></div>
    </div>

    <main id="portfolio-grid"></main>
    <div id="pagination-container" class="pagination-container"></div>
    
    <footer>
        <p>© 2025 iLupo Warehouse | Administrado por alberto64674yt</p>
    </footer>

    <div id="easter-egg-overlay" class="easter-egg-overlay">
        <div class="easter-egg-content">
            <div id="video-container" class="video-container-easter-egg"></div>
            <p class="easter-egg-quote">"A veces es mejor dejar ciertas cosas sin descubrir"</p>
            <p class="easter-egg-signature">2025 - alberto64674yt</p>
            <button id="close-easter-egg" class="close-easter-egg-button">&times;</button>
        </div>
    </div>

    <div id="boykisser-overlay" class="bk-overlay">
        <audio id="boykisser-audio" src="https://files.catbox.moe/yqlere.mp3" preload="auto"></audio>
        <img src="https://i.imgur.com/3WbZsMt.png" alt="Boykisser" id="boykisser-char" class="bk-char">
        <div id="boykisser-bubble" class="bk-bubble">
            <p id="boykisser-text"></p>
        </div>
        <button id="boykisser-close" class="bk-close-btn">&times;</button>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/lunr/lunr.min.js"></script>
    <script>
        let allProjects = [];
        let activeTags = new Set();
        let currentPage = 1;
        const projectsPerPage = 9;
        const searchBox = document.getElementById('search-box');
        const grid = document.getElementById('portfolio-grid');
        const paginationContainer = document.getElementById('pagination-container');
        const tagContainer = document.getElementById('tag-filter-container');
		let searchIndex; // Variable para guardar el índice de búsqueda

        marked.setOptions({ gfm: true, breaks: true });

        const cardObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('is-visible');
                    observer.unobserve(entry.target);
                }
            });
        }, { threshold: 0.1 });
		
		function buildSearchIndex(proyectos) {
            searchIndex = lunr(function () {
                this.ref('id'); // Usamos el ID para identificar cada proyecto
                this.field('titulo', { boost: 10 }); // El título tiene 10 veces más importancia
                this.field('resumen', { boost: 5 });  // El resumen tiene 5 veces más importancia
                this.field('contenido_completo');    // El contenido completo tiene importancia normal
                this.field('tags');                  // También buscamos en las etiquetas

                proyectos.forEach(function (p) {
                    // CORRECCIÓN: Nos aseguramos de que las etiquetas se procesen correctamente
                    const docToAdd = {
                        id: p.id,
                        titulo: p.titulo,
                        resumen: p.resumen,
                        contenido_completo: p.contenido_completo,
                        tags: (p.tags || []).join(' ') // Convertimos el array de etiquetas en un texto simple
                    };
                    this.add(docToAdd);
                }, this);
            });
        }

        function renderCards(proyectos) {
            grid.innerHTML = '';
            if (!proyectos || proyectos.length === 0) {
                grid.innerHTML = '<p class="empty-message">No se han encontrado proyectos que coincidan con todos los filtros.</p>';
                return;
            }
            const paginatedProjects = proyectos.slice().reverse().slice((currentPage - 1) * projectsPerPage, currentPage * projectsPerPage);
            
            paginatedProjects.forEach((proyecto, index) => {
                const card = document.createElement('a');
                card.className = 'card';
                card.href = `proyecto.html?id=${proyecto.id}`;
                card.addEventListener('mousemove', e => {
                    const rect = e.currentTarget.getBoundingClientRect(), x = e.clientX - rect.left, y = e.clientY - rect.top, centerX = rect.width / 2, centerY = rect.height / 2, rotateX = (y - centerY) / 15, rotateY = (centerX - x) / 15;
                    e.currentTarget.querySelector('.card-inner').style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.05)`;
                });
                card.addEventListener('mouseleave', e => { e.currentTarget.querySelector('.card-inner').style.transform = 'rotateX(0) rotateY(0) scale(1)'; });
                card.innerHTML = `<div class="card-inner"><img class="card-hero-image" src="${proyecto.imagen || ''}" alt="${proyecto.titulo}" loading="lazy"><div class="card-content"><h2>${proyecto.titulo}</h2><div class="card-excerpt">${marked.parse(proyecto.resumen || '')}</div><span class="button-imitation">Ver detalles</span></div></div>`;
                grid.appendChild(card);
                
                const isPreview = (window.self !== window.top);
                if (isPreview || index < 3) {
                    // Si estamos en la vista previa O es una de las 3 primeras tarjetas, hazla visible al instante.
                    card.classList.add('is-visible');
                } else {
                    // Para el resto, usa el observer para el efecto de scroll.
                    cardObserver.observe(card);
                }
            });
        }

        function setupPagination(totalProjects) {
            paginationContainer.innerHTML = '';
            const totalPages = Math.ceil(totalProjects / projectsPerPage);
            if (totalPages <= 1) return;
            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.innerText = i;
                pageButton.className = 'page-btn';
                if (i === currentPage) pageButton.classList.add('active');
                pageButton.addEventListener('click', () => {
                    currentPage = i;
                    filterAndRender();
                    const headerOffset = document.querySelector('header').offsetHeight;
                    window.scrollTo({ top: headerOffset, behavior: 'smooth' });
                });
                paginationContainer.appendChild(pageButton);
            }
        }
        
        let tagTree = {};

        function buildAndRenderTags(proyectos) {
            tagTree = {};
            proyectos.forEach(p => {
                (p.tags || []).forEach(fullTag => {
                    let currentNode = tagTree;
                    fullTag.split(' > ').forEach(part => {
                        if (!currentNode[part]) currentNode[part] = { children: {} };
                        currentNode = currentNode[part].children;
                    });
                });
            });

            function processTree(nodeLevel, pathPrefix = '') {
                Object.keys(nodeLevel).forEach(key => {
                    const currentNode = nodeLevel[key];
                    const currentPath = pathPrefix ? `${pathPrefix} > ${key}` : key;
                    currentNode.path = currentPath;
                    currentNode.count = allProjects.filter(p => (p.tags || []).some(tag => tag.startsWith(currentPath))).length;
                    if (Object.keys(currentNode.children).length > 0) {
                        processTree(currentNode.children, currentPath);
                    }
                });
            }
            processTree(tagTree);
            
            tagContainer.innerHTML = '';
            const allBtnContainer = document.createElement('div');
            allBtnContainer.className = 'tag-item';
            const allBtn = document.createElement('button');
            allBtn.className = 'tag-button active';
            allBtn.innerText = `Todos (${proyectos.length})`;
            allBtn.onclick = () => {
                activeTags.clear();
                document.querySelectorAll('.tag-checkbox').forEach(cb => cb.checked = false);
                updateAllButtonStates();
                filterAndRender();
            };
            allBtnContainer.appendChild(allBtn);
            tagContainer.appendChild(allBtnContainer);

            renderTagTree(tagTree, tagContainer, 0);
        }

        function renderTagTree(tree, container, level) {
            const sortedKeys = Object.keys(tree).sort();

            sortedKeys.forEach(key => {
                const node = tree[key];
                const nodeName = node.path.split(' > ').pop();
                const hasChildren = Object.keys(node.children).length > 0;
                const inputId = `cb-${node.path.replace(/\s|>/g, '-')}`;

                const itemWrapper = document.createElement('div');
                itemWrapper.className = 'tag-item';
                itemWrapper.style.marginLeft = `${level * 20}px`;
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = inputId;
                checkbox.className = 'tag-checkbox';
                checkbox.checked = activeTags.has(node.path);
                
                const label = document.createElement('label');
                label.className = 'tag-label';
                label.htmlFor = inputId;
                label.innerHTML = `${nodeName} <span class="tag-count">(${node.count})</span>`;

                let arrow = null;
                if (hasChildren) {
                    arrow = document.createElement('span');
                    arrow.className = 'arrow';
                    itemWrapper.appendChild(arrow);
                }

                itemWrapper.appendChild(checkbox);
                itemWrapper.appendChild(label);
                
                container.appendChild(itemWrapper);

                if (hasChildren) {
                    const childrenContainer = document.createElement('div');
                    childrenContainer.className = 'tag-children-container';
                    itemWrapper.appendChild(childrenContainer);

                    const toggleFunc = (e) => {
                        e.stopPropagation();
                        itemWrapper.classList.toggle('expanded');
                        childrenContainer.classList.toggle('visible');
                    };

                    label.addEventListener('click', toggleFunc);
                    arrow.addEventListener('click', toggleFunc);
                    
                    renderTagTree(node.children, childrenContainer, level + 1);
                }

                checkbox.addEventListener('change', () => {
                    if (checkbox.checked) {
                        activeTags.add(node.path);
                    } else {
                        activeTags.delete(node.path);
                    }
                    updateAllButtonStates();
                    filterAndRender();
                });
            });
        }

        function updateAllButtonStates() {
            const hasActiveTags = activeTags.size > 0;
            document.querySelector('.tag-button').classList.toggle('active', !hasActiveTags);
        }

        function filterAndRender() {
            const searchTerm = searchBox.value.toLowerCase().trim();
            let filtered = [];

            if (searchTerm) {
                // Si hay un término de búsqueda, usamos el índice de Lunr.js
                const searchResults = searchIndex.search(searchTerm + '*'); // El '*' permite buscar mientras escribes
                // Mapeamos los resultados (que solo tienen el ID) a los objetos de proyecto completos
                filtered = searchResults.map(result => {
                    return allProjects.find(p => p.id === result.ref);
                });
            } else {
                // Si no hay búsqueda, usamos la lista completa de proyectos
                filtered = allProjects;
            }

            if (activeTags.size > 0) {
                const activeTagsArr = [...activeTags];
                filtered = filtered.filter(p => {
                    return activeTagsArr.every(activeTagPath => {
                        return (p.tags || []).some(projectTag => projectTag.startsWith(activeTagPath));
                    });
                });
            }

            renderCards(filtered);
            setupPagination(filtered.length);
            updateAllButtonStates();
            updateURLParameters();
        }

        fetch('proyectos.json').then(r=>r.json()).then(data=>{
            allProjects=data.items||[];
			buildSearchIndex(allProjects);
            window.proyectos=allProjects;
            buildAndRenderTags(allProjects);
            filterAndRender();
        }).catch(e=>{console.error(e); grid.innerHTML='<p class="empty-message">Error al cargar proyectos.</p>'});

        searchBox.addEventListener('input', () => { currentPage = 1; filterAndRender(); });
        const gridBtn = document.getElementById('grid-view-btn');
        const listBtn = document.getElementById('list-view-btn');
        gridBtn.addEventListener('click', () => { grid.classList.remove('view-list'); gridBtn.classList.add('active'); listBtn.classList.remove('active'); });
        listBtn.addEventListener('click', () => { grid.classList.add('view-list'); listBtn.classList.add('active'); gridBtn.classList.remove('active'); });
        window.addEventListener('message', e => { if (e.data.type === 'previewUpdate') { allProjects = e.data.payload; buildAndRenderTags(allProjects); filterAndRender(); } });
    </script>
    
    <script>
        (function() {
            // --- LÓGICA DE EASTER EGGS Y CÓDIGOS SECRETOS ---

            // --- SISTEMA DE ACCESO SECRETO (ACTUALIZADO) ---
            let userInput = "";
            const subtitleElement = document.getElementById('subtitle');
            
            const secretActions = {
                "admin": () => {
                    alert('Acceso correcto. Redirigiendo...');
                    window.location.href = 'panel.html';
                },
                "boykisser": () => {
                    showBoykisserEasterEgg();
                }
            };

            if (subtitleElement) {
                const text = subtitleElement.innerText;
                subtitleElement.innerHTML = '';
                text.split('').forEach(char => {
                    const charSpan = document.createElement('span');
                    charSpan.textContent = char;
                    subtitleElement.appendChild(charSpan);
                });

                document.addEventListener('click', function(e) {
                    if (e.target.parentElement === subtitleElement) {
                        const letter = e.target.textContent.toLowerCase();
                        userInput += letter;

                        let matchFound = false;
                        for (const word in secretActions) {
                            if (word.startsWith(userInput)) {
                                matchFound = true;
                                if (userInput === word) {
                                    secretActions[word]();
                                    userInput = "";
                                    break;
                                }
                            }
                        }
                        if (!matchFound) {
                            userInput = "";
                        }
                    }
                });
            }

            // --- EASTER EGG #1: TÍTULO 5 CLICS ---
            const titleElement = document.querySelector('#main-header h1');
            const videoOverlay = document.getElementById('easter-egg-overlay');
            const videoContainer = document.getElementById('video-container');
            const closeVideoBtn = document.getElementById('close-easter-egg');
            let clickCount = 0; let timer;

            titleElement.addEventListener('click', function() {
                clickCount++;
                clearTimeout(timer);
                timer = setTimeout(() => { clickCount = 0; }, 1000);
                if (clickCount === 5) {
                    clickCount = 0;
                    alert("Has Encontrado algo que no deberías poder estar viéndo, tanto tiempo libre tienes para toquetear toda la pagina y descubrir esto? bueno aqui tienes tu hallazgo:");
                    videoContainer.innerHTML = '<iframe src="https://www.youtube.com/embed/bN1shALfJqg?autoplay=1&loop=1&controls=0&playlist=bN1shALfJqg" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>';
                    videoOverlay.style.display = 'flex';
                }
            });
            closeVideoBtn.addEventListener('click', function() {
                videoOverlay.style.display = 'none';
                videoContainer.innerHTML = '';
            });

            // --- EASTER EGG #2: BOYKISSER (LÓGICA CORREGIDA) ---
            const bkOverlay = document.getElementById('boykisser-overlay');
            const bkChar = document.getElementById('boykisser-char');
            const bkAudio = document.getElementById('boykisser-audio');
            const bkTextElement = document.getElementById('boykisser-text');
            const bkCloseBtn = document.getElementById('boykisser-close');
            let typewriterInterval;
            let startTypingTimeout;

            function showBoykisserEasterEgg() {
                // 1. Reiniciar estado antes de empezar
                bkTextElement.innerHTML = '';
                bkCloseBtn.style.display = 'none';
                bkChar.style.transition = 'none'; // Desactivar transición para el reseteo
                bkChar.style.left = '-100%'; // Posición inicial fuera de pantalla
                bkAudio.currentTime = 0;
                clearInterval(typewriterInterval);
                clearTimeout(startTypingTimeout);

                // 2. Mostrar el overlay (fondo oscuro y borroso)
                bkOverlay.classList.add('visible');

                // 3. Forzar al navegador a que aplique el reseteo antes de animar
                setTimeout(() => {
                    // Aumentar la duración de la transición para que se deslice más lentamente
                    bkChar.style.transition = 'left 2s cubic-bezier(0.25, 1, 0.5, 1)'; 
                    // Ajustar la posición final para que no esté tan a la derecha
                    bkChar.style.left = '35%'; // Esto se ajustará con el transform en CSS
                    bkAudio.play();
                }, 20); 

                const text = "you like kissing boys, don't you?";
                let i = 0;
                
                // 4. Programar el inicio del tipeo para que coincida con el audio y la animación del personaje
                startTypingTimeout = setTimeout(() => {
                    typewriterInterval = setInterval(() => {
                        if (i < text.length) {
                            bkTextElement.innerHTML += text.charAt(i);
                            i++;
                        } else {
                            clearInterval(typewriterInterval);
                        }
                    }, 65);
                }, 1400);
            }

            bkAudio.onended = function() {
                clearInterval(typewriterInterval);
                bkTextElement.innerHTML = "you like kissing boys, don't you?";
                bkCloseBtn.style.display = 'block';
            };
            
            bkCloseBtn.addEventListener('click', function() {
                bkOverlay.classList.remove('visible');
                clearInterval(typewriterInterval);
                clearTimeout(startTypingTimeout);
                bkAudio.pause();
                bkAudio.currentTime = 0;
            });

        })();
    </script>
</body>
</html>

