<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iLupo Warehouse</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header id="main-header" class="no-select">
        <h1>iLupo Warehouse</h1>
        <p class="subtitle">
            Un port<span class="secret-letter" data-key="0">a</span>folio 
            <span class="secret-letter" data-key="1">d</span>e herra<span class="secret-letter" data-key="2">m</span>ientas 
            e <span class="secret-letter" data-key="3">i</span>nve<span class="secret-letter" data-key="4">n</span>ciones.
        </p>
    </header>

    <div class="filter-controls">
        <a href="sobre-mi.html" class="about-me-button">Sobre Mí</a>
        <div class="top-controls">
            <div class="search-container">
                <input type="text" id="search-box" placeholder="Buscar por nombre...">
            </div>
            <div class="view-switcher">
                <button id="grid-view-btn" class="view-btn active" title="Vista de Rejilla">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3,3V11H11V3M9,9H5V5H9M3,13V21H11V13M9,19H5V15H9M13,3V11H21V3M19,9H15V5H19M13,13V21H21V13M19,19H15V15H19Z"/></svg>
                </button>
                <button id="list-view-btn" class="view-btn" title="Vista de Lista">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3,4H21V6H3V4M3,11H21V13H3V11M3,18H21V20H3V18Z"/></svg>
                </button>
            </div>
        </div>
        <div id="tag-filter-container" class="tag-filter-container"></div>
    </div>

    <main id="portfolio-grid"></main>
    <div id="pagination-container" class="pagination-container"></div>
    
    <footer>
        <p>© 2025 iLupo Warehouse | Administrado por alberto64674yt</p>
    </footer>

    <div id="easter-egg-overlay" class="easter-egg-overlay">
        <div class="easter-egg-content">
            <div id="video-container" class="video-container-easter-egg"></div>
            <p class="easter-egg-quote">"A veces es mejor dejar ciertas cosas sin descubrir"</p>
            <p class="easter-egg-signature">2025 - alberto64674yt</p>
            <button id="close-easter-egg" class="close-easter-egg-button">&times;</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        let allProjects = [];
        let activeTags = new Set();
        let currentPage = 1;
        const projectsPerPage = 9;
        const searchBox = document.getElementById('search-box');
        const grid = document.getElementById('portfolio-grid');
        const paginationContainer = document.getElementById('pagination-container');
        const tagContainer = document.getElementById('tag-filter-container');

        marked.setOptions({ gfm: true, breaks: true });

        const cardObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('is-visible');
                    observer.unobserve(entry.target);
                }
            });
        }, { threshold: 0.1 });

        function renderCards(proyectos) {
            grid.innerHTML = '';
            if (!proyectos || proyectos.length === 0) {
                grid.innerHTML = '<p class="empty-message">No se han encontrado proyectos que coincidan con todos los filtros.</p>';
                return;
            }
            const paginatedProjects = proyectos.slice().reverse().slice((currentPage - 1) * projectsPerPage, currentPage * projectsPerPage);
            paginatedProjects.forEach((proyecto) => {
                const card = document.createElement('a');
                card.className = 'card';
                card.href = `proyecto.html?id=${proyecto.id}`;
                card.addEventListener('mousemove', e => {
                    const rect = e.currentTarget.getBoundingClientRect(), x = e.clientX - rect.left, y = e.clientY - rect.top, centerX = rect.width / 2, centerY = rect.height / 2, rotateX = (y - centerY) / 15, rotateY = (centerX - x) / 15;
                    e.currentTarget.querySelector('.card-inner').style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.05)`;
                });
                card.addEventListener('mouseleave', e => { e.currentTarget.querySelector('.card-inner').style.transform = 'rotateX(0) rotateY(0) scale(1)'; });
                card.innerHTML = `<div class="card-inner"><img class="card-hero-image" src="${proyecto.imagen}" alt="${proyecto.titulo}"><div class="card-content"><h2>${proyecto.titulo}</h2><div class="card-excerpt">${marked.parse(proyecto.resumen || '')}</div><span class="button-imitation">Ver detalles</span></div></div>`;
                grid.appendChild(card);
                cardObserver.observe(card);
            });
        }

        function setupPagination(totalProjects) {
            paginationContainer.innerHTML = '';
            const totalPages = Math.ceil(totalProjects / projectsPerPage);
            if (totalPages <= 1) return;
            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.innerText = i;
                pageButton.className = 'page-btn';
                if (i === currentPage) pageButton.classList.add('active');
                pageButton.addEventListener('click', () => {
                    currentPage = i;
                    filterAndRender();
                    const headerOffset = document.querySelector('header').offsetHeight;
                    window.scrollTo({ top: headerOffset, behavior: 'smooth' });
                });
                paginationContainer.appendChild(pageButton);
            }
        }
        
        let tagTree = {};
        let openDropdown = null;

        function buildAndRenderTags(proyectos) {
            // Construir el árbol de datos
            tagTree = {};
            proyectos.forEach(p => {
                (p.tags || []).forEach(fullTag => {
                    let currentNode = tagTree;
                    fullTag.split(' > ').forEach(part => {
                        if (!currentNode[part]) currentNode[part] = { children: {} };
                        currentNode = currentNode[part].children;
                    });
                });
            });

            function processTree(nodeLevel, pathPrefix = '') {
                Object.keys(nodeLevel).forEach(key => {
                    const currentNode = nodeLevel[key];
                    const currentPath = pathPrefix ? `${pathPrefix} > ${key}` : key;
                    currentNode.path = currentPath;
                    currentNode.count = allProjects.filter(p => (p.tags || []).some(tag => tag.startsWith(currentPath))).length;
                    if (Object.keys(currentNode.children).length > 0) {
                        processTree(currentNode.children, currentPath);
                    }
                });
            }
            processTree(tagTree);
            
            // Renderizar los botones de nivel superior
            tagContainer.innerHTML = ''; // Limpiar
            const allBtn = document.createElement('button');
            allBtn.className = 'tag-button active';
            allBtn.innerText = `Todos (${proyectos.length})`;
            allBtn.onclick = () => {
                activeTags.clear();
                closeOpenDropdown();
                updateAllButtonStates();
                filterAndRender();
            };
            tagContainer.appendChild(allBtn);
            
            Object.keys(tagTree).sort().forEach(key => {
                const node = tagTree[key];
                const button = createTagButton(node, 0);
                tagContainer.appendChild(button);
            });
        }

        function createTagButton(node, level) {
            const hasChildren = Object.keys(node.children).length > 0;
            const nodeName = node.path.split(' > ').pop();

            const button = document.createElement('button');
            button.className = 'tag-button hier-tag-button';
            button.dataset.path = node.path;
            button.innerHTML = hasChildren ? `<span class="arrow"></span>${nodeName} (${node.count})` : `${nodeName} (${node.count})`;
            button.style.paddingLeft = `${12 + (level * 15)}px`;
            
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                // Lógica de filtrado
                if (activeTags.has(node.path)) {
                    activeTags.delete(node.path);
                } else {
                    activeTags.add(node.path);
                }
                updateAllButtonStates();
                filterAndRender();
                
                // Lógica del menú desplegable
                if (hasChildren) {
                    const isAlreadyOpen = button.classList.contains('expanded');
                    closeOpenDropdown();
                    if (!isAlreadyOpen) {
                        showDropdownFor(button, node);
                    }
                } else {
                    closeOpenDropdown();
                }
            });
            return button;
        }

        function showDropdownFor(button, node) {
            const dropdown = document.createElement('div');
            dropdown.className = 'tag-dropdown-menu';

            Object.keys(node.children).sort().forEach(key => {
                const childNode = node.children[key];
                const childButton = createTagButton(childNode, 1); // Asumimos un nivel más por ahora
                dropdown.appendChild(childButton);
            });
            
            document.body.appendChild(dropdown);
            
            const rect = button.getBoundingClientRect();
            dropdown.style.left = `${rect.left + window.scrollX}px`;
            dropdown.style.top = `${rect.bottom + window.scrollY + 5}px`;

            button.classList.add('expanded');
            openDropdown = { element: dropdown, button: button };
        }

        function closeOpenDropdown() {
            if (openDropdown) {
                openDropdown.element.remove();
                openDropdown.button.classList.remove('expanded');
                openDropdown = null;
            }
        }

        function updateAllButtonStates() {
            document.querySelectorAll('.tag-button').forEach(btn => {
                const path = btn.dataset.path;
                if (path === 'all') {
                    btn.classList.toggle('active', activeTags.size === 0);
                } else if (path) {
                    btn.classList.toggle('active', activeTags.has(path));
                }
            });
        }
        
        document.addEventListener('click', (e) => {
            if (openDropdown && !openDropdown.element.contains(e.target) && !e.target.closest('.hier-tag-button')) {
                closeOpenDropdown();
            }
        });

        function filterAndRender() {
            const searchTerm = searchBox.value.toLowerCase();
            let filtered = allProjects;
            if (searchTerm) {
                filtered = filtered.filter(p => p.titulo.toLowerCase().includes(searchTerm));
            }
            if (activeTags.size > 0) {
                const activeTagsArr = [...activeTags];
                filtered = filtered.filter(p => {
                    return activeTagsArr.every(activeTagPath => {
                        return (p.tags || []).some(projectTag => projectTag.startsWith(activeTagPath));
                    });
                });
            }
            renderCards(filtered);
            setupPagination(filtered.length);
        }

        fetch('proyectos.json').then(r=>r.json()).then(data=>{
            allProjects=data.items||[];
            window.proyectos=allProjects;
            buildAndRenderTags(allProjects);
            filterAndRender();
        }).catch(e=>{console.error(e); grid.innerHTML='<p class="empty-message">Error al cargar proyectos.</p>'});

        searchBox.addEventListener('input', () => { currentPage = 1; filterAndRender(); });
        gridBtn = document.getElementById('grid-view-btn');
        listBtn = document.getElementById('list-view-btn');
        gridBtn.addEventListener('click', () => { grid.classList.remove('view-list'); gridBtn.classList.add('active'); listBtn.classList.remove('active'); });
        listBtn.addEventListener('click', () => { grid.classList.add('view-list'); listBtn.classList.add('active'); gridBtn.classList.remove('active'); });
        window.addEventListener('message', e => { if (e.data.type === 'previewUpdate') { allProjects = e.data.payload; buildAndRenderTags(allProjects); filterAndRender(); } });
    </script>
    
    <script>
        (function() {
            const requiredLength = 5; let progress = 0;
            document.addEventListener('click', function(e) {
                const target = e.target;
                if (target.classList.contains('secret-letter') && parseInt(target.dataset.key) === progress) {
                    progress++;
                } else if (!target.classList.contains('secret-letter')) {
                    progress = 0;
                }
                if (progress === requiredLength) {
                    alert('Acceso correcto. Redirigiendo...');
                    window.location.href = 'panel.html';
                }
            });

            const titleElement = document.querySelector('#main-header h1');
            const overlay = document.getElementById('easter-egg-overlay');
            const videoContainer = document.getElementById('video-container');
            const closeButton = document.getElementById('close-easter-egg');
            let clickCount = 0; let timer;
            titleElement.addEventListener('click', function() {
                clickCount++;
                clearTimeout(timer);
                timer = setTimeout(() => { clickCount = 0; }, 1000);
                if (clickCount === 5) {
                    clickCount = 0;
                    alert("Has Encontrado algo que no deberías poder estar viéndo, tanto tiempo libre tienes para toquetear toda la pagina y descubrir esto? bueno aqui tienes tu hallazgo:");
                    videoContainer.innerHTML = '<iframe src="https://www.youtube.com/embed/bN1shALfJqg?autoplay=1&loop=1&controls=0&playlist=bN1shALfJqg" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>';
                    overlay.style.display = 'flex';
                }
            });
            closeButton.addEventListener('click', function() {
                overlay.style.display = 'none';
                videoContainer.innerHTML = '';
            });
        })();
    </script>
</body>
</html>
